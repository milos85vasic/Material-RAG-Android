








<!doctype html>
<html 
      lang="en"
      dir="ltr">
  <head>
    <meta name="google-signin-client-id" content="721724668570-nbkv1cfusk7kk4eni4pjvepaus73b13t.apps.googleusercontent.com">
    <meta name="google-signin-scope"
          content="profile email https://www.googleapis.com/auth/developerprofiles https://www.googleapis.com/auth/developerprofiles.award">
    <meta property="og:site_name" content="Android Developers">
    <meta property="og:type" content="website"><meta name="theme-color" content="#34a853"><meta charset="utf-8">
    <meta content="IE=Edge" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <link rel="manifest" href="/_pwa/android/manifest.json"
          crossorigin="use-credentials">
    <link rel="preconnect" href="//www.gstatic.com" crossorigin>
    <link rel="preconnect" href="//fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="//fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="//apis.google.com" crossorigin>
    <link rel="preconnect" href="//www.google-analytics.com" crossorigin><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Google+Sans:400,500,600,700|Google+Sans+Text:400,400italic,500,500italic,600,600italic,700,700italic|Roboto+Mono:400,500,700&display=swap">
      <link rel="stylesheet"
            href="//fonts.googleapis.com/css2?family=Material+Icons&family=Material+Symbols+Outlined&display=block"><link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/css/app.css">
      
        <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/css/dark-theme.css" disabled>
      <link rel="shortcut icon" href="https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/images/favicon.svg">
    <link rel="apple-touch-icon" href="https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/images/touchicon-180.png"><link rel="canonical" href="https://developer.android.com/codelabs/advanced-kotlin-coroutines"><link rel="search" type="application/opensearchdescription+xml"
            title="Android Developers" href="https://developer.android.com/s/opensearch.xml">
      <link rel="alternate" hreflang="en"
          href="https://developer.android.com/codelabs/advanced-kotlin-coroutines" /><link rel="alternate" hreflang="x-default" href="https://developer.android.com/codelabs/advanced-kotlin-coroutines" /><link rel="alternate" hreflang="zh-Hans"
          href="https://developer.android.com/codelabs/advanced-kotlin-coroutines?hl=zh-cn" /><link rel="alternate" hreflang="fr"
          href="https://developer.android.com/codelabs/advanced-kotlin-coroutines?hl=fr" /><link rel="alternate" hreflang="id"
          href="https://developer.android.com/codelabs/advanced-kotlin-coroutines?hl=id" /><link rel="alternate" hreflang="ja"
          href="https://developer.android.com/codelabs/advanced-kotlin-coroutines?hl=ja" /><link rel="alternate" hreflang="ko"
          href="https://developer.android.com/codelabs/advanced-kotlin-coroutines?hl=ko" /><link rel="alternate" hreflang="es-419"
          href="https://developer.android.com/codelabs/advanced-kotlin-coroutines?hl=es-419" /><title>(Deprecated) Learn advanced coroutines with Kotlin Flow and LiveData &nbsp;|&nbsp; Android Developers</title>

<meta property="og:title" content="(Deprecated) Learn advanced coroutines with Kotlin Flow and LiveData &nbsp;|&nbsp; Android Developers"><meta name="description" content="In this codelab, you’ll build a coroutine-based Android app that uses Architecture Components to fetch data from the network and a Room database.">
  <meta property="og:description" content="In this codelab, you’ll build a coroutine-based Android app that uses Architecture Components to fetch data from the network and a Room database."><meta property="og:url" content="https://developer.android.com/codelabs/advanced-kotlin-coroutines"><meta property="og:locale" content="en">
  
    
    
    
    
    
    
    
    
  

    
      <link rel="stylesheet" href="/extras.css"></head>
  <body class=""
        template="codelab"
        theme="android-theme"
        type="codelab"
        
        
        appearance
        
        layout="docs"
        
        
        
        
        display-toc
        pending>
  
    <devsite-progress type="indeterminate" id="app-progress"></devsite-progress>
  
  
    <a href="#main-content" class="skip-link button">
      
      Skip to main content
    </a>
    <section class="devsite-wrapper">
      <devsite-cookie-notification-bar></devsite-cookie-notification-bar><devsite-header role="banner">
  
    





















<div class="devsite-header--inner" data-nosnippet>
  <div class="devsite-top-logo-row-wrapper-wrapper">
    <div class="devsite-top-logo-row-wrapper">
      <div class="devsite-top-logo-row">
        <button type="button" id="devsite-hamburger-menu"
          class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
          data-category="Site-Wide Custom Events"
          data-label="Navigation menu button"
          visually-hidden
          aria-label="Open menu">
        </button>
        
<div class="devsite-product-name-wrapper">

  <a href="/" class="devsite-site-logo-link gc-analytics-event"
   data-category="Site-Wide Custom Events" data-label="Site logo" track-type="globalNav"
   track-name="androidDevelopers" track-metadata-position="nav"
   track-metadata-eventDetail="nav">
  
  <picture>
    
    <source srcset="https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/images/lockup-dark-theme.png"
            media="(prefers-color-scheme: dark)"
            class="devsite-dark-theme">
    
    <img src="https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/images/lockup.png" class="devsite-site-logo" alt="Android Developers">
  </picture>
  
</a>



</div>
        <div class="devsite-top-logo-row-middle">
          <div class="devsite-header-upper-tabs">
            
           </div>
          
<devsite-search
    enable-signin
    enable-search
    enable-suggestions
      enable-query-completion
    
    enable-search-summaries
    
    tenant-name="Android Developers"
    
    
    
    
    
    >
  <form class="devsite-search-form" action="https://developer.android.com/s/results" method="GET">
    <div class="devsite-search-container">
      <button type="button"
              search-open
              class="devsite-search-button devsite-header-icon-button button-flat material-icons"
              
              aria-label="Open search"></button>
      <div class="devsite-searchbox">
        <input
          aria-activedescendant=""
          aria-autocomplete="list"
          
          aria-label="Search"
          aria-expanded="false"
          aria-haspopup="listbox"
          autocomplete="off"
          class="devsite-search-field devsite-search-query"
          name="q"
          
          placeholder="Search"
          role="combobox"
          type="text"
          value=""
          >
          <div class="devsite-search-image material-icons" aria-hidden="true">
            
              <svg class="devsite-search-ai-image" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <g clip-path="url(#clip0_6641_386)">
                    <path d="M19.6 21L13.3 14.7C12.8 15.1 12.225 15.4167 11.575 15.65C10.925 15.8833 10.2333 16 9.5 16C7.68333 16 6.14167 15.375 4.875 14.125C3.625 12.8583 3 11.3167 3 9.5C3 7.68333 3.625 6.15 4.875 4.9C6.14167 3.63333 7.68333 3 9.5 3C10.0167 3 10.5167 3.05833 11 3.175C11.4833 3.275 11.9417 3.43333 12.375 3.65L10.825 5.2C10.6083 5.13333 10.3917 5.08333 10.175 5.05C9.95833 5.01667 9.73333 5 9.5 5C8.25 5 7.18333 5.44167 6.3 6.325C5.43333 7.19167 5 8.25 5 9.5C5 10.75 5.43333 11.8167 6.3 12.7C7.18333 13.5667 8.25 14 9.5 14C10.6667 14 11.6667 13.625 12.5 12.875C13.35 12.1083 13.8417 11.15 13.975 10H15.975C15.925 10.6333 15.7833 11.2333 15.55 11.8C15.3333 12.3667 15.05 12.8667 14.7 13.3L21 19.6L19.6 21ZM17.5 12C17.5 10.4667 16.9667 9.16667 15.9 8.1C14.8333 7.03333 13.5333 6.5 12 6.5C13.5333 6.5 14.8333 5.96667 15.9 4.9C16.9667 3.83333 17.5 2.53333 17.5 0.999999C17.5 2.53333 18.0333 3.83333 19.1 4.9C20.1667 5.96667 21.4667 6.5 23 6.5C21.4667 6.5 20.1667 7.03333 19.1 8.1C18.0333 9.16667 17.5 10.4667 17.5 12Z" fill="#5F6368"/>
                  </g>
                <defs>
                <clipPath id="clip0_6641_386">
                <rect width="24" height="24" fill="white"/>
                </clipPath>
                </defs>
              </svg>
            
          </div>
          <div class="devsite-search-shortcut-icon-container" aria-hidden="true">
            <kbd class="devsite-search-shortcut-icon">/</kbd>
          </div>
      </div>
    </div>
  </form>
  <button type="button"
          search-close
          class="devsite-search-button devsite-header-icon-button button-flat material-icons"
          
          aria-label="Close search"></button>
</devsite-search>

        </div>

        

          

          

          <devsite-appearance-selector></devsite-appearance-selector>

          
<devsite-language-selector>
  <ul role="presentation">
    
    
    <li role="presentation">
      <a role="menuitem" lang="en"
        >English</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="de"
        >Deutsch</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="es_419"
        >Español – América Latina</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="fr"
        >Français</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="id"
        >Indonesia</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="pl"
        >Polski</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="pt_br"
        >Português – Brasil</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="vi"
        >Tiếng Việt</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="zh_cn"
        >中文 – 简体</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="ja"
        >日本語</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="ko"
        >한국어</a>
    </li>
    
  </ul>
</devsite-language-selector>


          
            <a class="devsite-header-link devsite-top-button button gc-analytics-event "
    href="https://developer.android.com/studio"
    data-category="Site-Wide Custom Events"
    data-label="Site header link: Android Studio"
    >
  Android Studio
</a>
          

        

        
          <devsite-user 
                        
                        
                          enable-profiles
                        
                        
                        id="devsite-user">
            
              
              <span class="button devsite-top-button" aria-hidden="true" visually-hidden>Sign in</span>
            
          </devsite-user>
        
        
        
      </div>
    </div>
  </div>



</div>



  
</devsite-header>
      <devsite-book-nav scrollbars hidden>
        
          





















<div class="devsite-book-nav-filter"
     hidden>
  <span class="filter-list-icon material-icons" aria-hidden="true"></span>
  <input type="text"
         placeholder="Filter"
         
         aria-label="Type to filter"
         role="searchbox">
  
  <span class="filter-clear-button hidden"
        data-title="Clear filter"
        aria-label="Clear filter"
        role="button"
        tabindex="0"></span>
</div>

<nav class="devsite-book-nav devsite-nav nocontent"
     aria-label="Side menu">
  <div class="devsite-mobile-header">
    <button type="button"
            id="devsite-close-nav"
            class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
            data-category="Site-Wide Custom Events"
            data-label="Close navigation"
            aria-label="Close navigation">
    </button>
    <div class="devsite-product-name-wrapper">

  <a href="/" class="devsite-site-logo-link gc-analytics-event"
   data-category="Site-Wide Custom Events" data-label="Site logo" track-type="globalNav"
   track-name="androidDevelopers" track-metadata-position="nav"
   track-metadata-eventDetail="nav">
  
  <picture>
    
    <source srcset="https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/images/lockup-dark-theme.png"
            media="(prefers-color-scheme: dark)"
            class="devsite-dark-theme">
    
    <img src="https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/images/lockup.png" class="devsite-site-logo" alt="Android Developers">
  </picture>
  
</a>


</div>
  </div>

  <div class="devsite-book-nav-wrapper">
    <div class="devsite-mobile-nav-top">
      
        <ul class="devsite-nav-list">
          
          
    
    
<li class="devsite-nav-item">

  
  <a href="/studio"
    
       class="devsite-nav-title gc-analytics-event "
    

    
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Android Studio"
     track-type="navMenu"
     track-metadata-eventDetail="globalMenu"
     track-metadata-position="nav">
  
    <span class="devsite-nav-text" tooltip >
      Android Studio
   </span>
    
  
  </a>
  

</li>

  
          
        </ul>
      
    </div>
    
  </div>
</nav>
        
      </devsite-book-nav>
      <section id="gc-wrapper">
        <main role="main" id="main-content" class="devsite-main-content"
            
              
              has-sidebar
            >
          <div class="devsite-sidebar">
            <div class="devsite-sidebar-content">
                
                <devsite-toc class="devsite-nav"
                            role="navigation"
                            aria-label="On this page"
                            depth="1"
                            scrollbars
                  ></devsite-toc>
                <devsite-recommendations-sidebar class="nocontent devsite-nav">
                </devsite-recommendations-sidebar>
            </div>
          </div>
          <devsite-content>
            
              












<article class="devsite-article"><style>
      body {
        transition: opacity ease-in 0.2s;
      }

      body[unresolved] {
        opacity: 0;
        display: block;
        overflow: hidden;
        position: relative;
      }
      </style>
  
  
  
  
  

  <div class="devsite-article-meta nocontent" role="navigation">
    
    
    <ul class="devsite-breadcrumb-list"
  >
  
</ul>
    
  </div>
  
    <h1 class="devsite-page-title" tabindex="-1">
      (Deprecated) Learn advanced coroutines with Kotlin Flow and LiveData<div class="devsite-actions" hidden data-nosnippet><devsite-feature-tooltip
      ack-key="AckCollectionsBookmarkTooltipDismiss"
      analytics-category="Site-Wide Custom Events"
      analytics-action-show="Callout Profile displayed"
      analytics-action-close="Callout Profile dismissed"
      analytics-label="Create Collection Callout"
      class="devsite-page-bookmark-tooltip nocontent"
      dismiss-button="true"
      id="devsite-collections-dropdown"
      
      dismiss-button-text="Dismiss"

      
      close-button-text="Got it">

    
    
      <devsite-bookmark></devsite-bookmark>
    

    <span slot="popout-heading">
      
      Stay organized with collections
    </span>
    <span slot="popout-contents">
      
      Save and categorize content based on your preferences.
    </span>
  </devsite-feature-tooltip></div>
  
      
    </h1>
  

  <devsite-toc class="devsite-nav"
    depth="1"
    devsite-toc-embedded
    >
  </devsite-toc>
  
    
  <div class="devsite-article-body clearfix
  ">

  
    
    
    <google-codelab-analytics gaid="UA-49880327-14" ga4id="G-JTFZSJVVVZ"></google-codelab-analytics>
    <google-codelab codelab-gaid=""
                    codelab-ga4id=""
                    doc-id="1vlPMTOeWfMqD5Jo4xsj9m2nVxjOiAws8_Cy4dJUFXd0"
                    id="advanced-kotlin-coroutines"
                    title="(Deprecated) Learn advanced coroutines with Kotlin Flow and LiveData"
                    no-tooltip=""
                    environment="web"
                    category=""
                    feedback-link="https://github.com/googlecodelabs/kotlin-coroutines/issues"
                    layout="paginated"
                    >
      
        <google-codelab-step label="Before you begin" duration="2" step="0">
          
            <google-codelab-about codelab-title="(Deprecated) Learn advanced coroutines with Kotlin Flow and LiveData"
                                  
                                  last-updated="2024-12-10T14:20:40Z"
                                  duration="57">
            </google-codelab-about>
          
          <h2 class="step-title" id="0" data-text="Before you begin" tabindex="-1">
              1. Before you begin
          </h2>
          <aside class="warning"><p> This codelab is deprecated and will be removed soon.</p>
</aside>
<p>In this codelab, you&#39;ll learn how to use the  <a href="https://developer.android.com/topic/libraries/architecture/coroutines#livedata" target="_blank"><code translate="no" dir="ltr">LiveData</code> builder</a> to combine  <a href="https://kotlinlang.org/docs/reference/coroutines-overview.html" target="_blank">Kotlin coroutines</a> with  <a href="https://developer.android.com/topic/libraries/architecture/livedata" target="_blank"><code translate="no" dir="ltr">LiveData</code></a> in an Android app. We&#39;ll also use  <a href="https://kotlinlang.org/docs/reference/coroutines/flow.html" target="_blank">Coroutines Asynchronous Flow</a>, which is a type from the coroutines library for representing an async sequence (or stream) of values, to implement the same thing.</p>
<p>You&#39;ll start with an existing app, built using  <a href="https://developer.android.com/topic/libraries/architecture/" target="_blank">Android Architecture Components</a>, that uses <code translate="no" dir="ltr">LiveData</code> to get a list of objects from a  <a href="http://developer.android.com/room" target="_blank"><code translate="no" dir="ltr">Room</code></a> database and display them in a <code translate="no" dir="ltr">RecyclerView</code> grid layout.</p>
<p>Here are some code snippets to give you an idea of what you&#39;ll be doing.  Here is the existing code to query the Room database:</p>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plants</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">LiveData&lt;List&lt;Plant&gt;</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlants</span><span class="devsite-syntax-p">()</span>
</code></pre></devsite-code>
<p>The <code translate="no" dir="ltr">LiveData</code> will be updated using the <code translate="no" dir="ltr">LiveData</code> builder and coroutines with additional sorting logic:</p>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plants</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">LiveData&lt;List&lt;Plant&gt;</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">liveData&lt;List&lt;Plant&gt;</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plantsLiveData</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlants</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">customSortOrder</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantsListSortOrderCache</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getOrAwait</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">emitSource</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">plantsLiveData</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">map</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantList</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantList</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">applySort</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">customSortOrder</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">})</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>You&#39;ll also implement the same logic with <code translate="no" dir="ltr">Flow</code>:</p>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">private</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">customSortFlow</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantsListSortOrderCache</span><span class="devsite-syntax-o">::</span><span class="devsite-syntax-n">getOrAwait</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">asFlow</span><span class="devsite-syntax-p">()</span>

<span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plantsFlow</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">Flow&lt;List&lt;Plant&gt;</span>&gt;
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-k">get</span><span class="devsite-syntax-p">()</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlantsFlow</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">combine</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">customSortFlow</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plants</span><span class="devsite-syntax-p">,</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">sortOrder</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">           </span><span class="devsite-syntax-n">plants</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">applySort</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">sortOrder</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">flowOn</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">defaultDispatcher</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">conflate</span><span class="devsite-syntax-p">()</span>
</code></pre></devsite-code>
<h2 is-upgraded id="prerequisites" data-text="Prerequisites" tabindex="-1"><strong>Prerequisites</strong></h2>
<ul>
<li>Experience with the Architecture Components <code translate="no" dir="ltr">ViewModel</code>, <code translate="no" dir="ltr">LiveData</code>, <code translate="no" dir="ltr">Repository</code>, and <code translate="no" dir="ltr">Room</code>.</li>
<li>Experience with Kotlin syntax, including extension functions and lambdas.</li>
<li>Experience with Kotlin Coroutines.</li>
<li>A basic understanding of using threads on Android, including the main thread, background threads, and callbacks.</li>
</ul>
<aside class="special"><ul>
<li>For an introduction to the Architecture Components used in this codelab, see  <a href="https://codelabs.developers.google.com/codelabs/android-room-with-a-view-kotlin/#0" target="_blank">Room with a View</a>.</li>
<li>For an introduction to Kotlin syntax, see  <a href="https://www.udacity.com/course/kotlin-bootcamp-for-programmers--ud9011" target="_blank">Kotlin Bootcamp for Programmers</a>.</li>
<li>For an introduction to Kotlin Coroutines, see  <a href="https://codelabs.developers.google.com/codelabs/kotlin-coroutines/" target="_blank">Using Kotlin Coroutines in your Android App</a></li>
</ul>
</aside>
<h2 is-upgraded id="what-youll-do" data-text="What you'll do" tabindex="-1"><strong>What you'll do</strong></h2>
<ul>
<li>Convert an existing <code translate="no" dir="ltr">LiveData</code> to use the Kotlin coroutines-friendly <code translate="no" dir="ltr">LiveData</code> builder.</li>
<li>Add logic within a <code translate="no" dir="ltr">LiveData</code> builder.</li>
<li>Use <code translate="no" dir="ltr">Flow</code> for asynchronous operations.</li>
<li>Combine <code translate="no" dir="ltr">Flows</code> and transform multiple asynchronous sources.</li>
<li>Control concurrency with <code translate="no" dir="ltr">Flows</code>.</li>
<li>Learn how to choose between <code translate="no" dir="ltr">LiveData</code> and <code translate="no" dir="ltr">Flow.</code></li>
</ul>
<h2 is-upgraded id="what-youll-need" data-text="What you'll need" tabindex="-1">What you'll need</h2>
<ul>
<li><a href="https://developer.android.com/studio/" target="_blank">Android Studio Arctic Fox</a>. The codelab may work with other versions, but some things might be missing or look different.</li>
</ul>
<p>If you run into any issues (code bugs, grammatical errors, unclear wording, etc.) as you work through this codelab, please report the issue via the &#34;Report a mistake&#34; link in the lower left corner of the codelab.</p>


        </google-codelab-step>
      
        <google-codelab-step label="Getting set up" duration="2" step="1">
          
          <h2 class="step-title" id="1" data-text="Getting set up" tabindex="-1">
              2. Getting set up
          </h2>
          <h2 is-upgraded id="download-the-code" data-text="Download the code" tabindex="-1">Download the code</h2>
<p>Click the following link to download all the code for this codelab:</p>
<p><a href="https://github.com/googlecodelabs/kotlin-coroutines/archive/master.zip" target="_blank"><button class="button button-primary button-with-icon"><span class="material-icons" aria-hidden="true" translate="no">file_download</span>Download zip</button></a></p>
<p>... or clone the GitHub repository from the command line by using the following command:</p>
<div></div><devsite-code><pre translate="no" dir="ltr" is-upgraded>$ git clone https://github.com/googlecodelabs/kotlin-coroutines.git
</pre></devsite-code>
<p>The code for this codelab is in the <code translate="no" dir="ltr">advanced-coroutines-codelab</code> directory.</p>
<aside class="special"><p>The <strong>advanced-coroutines-codelab</strong> directory in this repository contains several different modules:</p>
<ul>
<li><img alt="android_studio_folder.png" style="width: 20.00px" src="/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647.png" srcset="https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_36.png 36w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_48.png 48w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_72.png 72w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_96.png 96w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_480.png 480w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_720.png 720w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_856.png 856w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_960.png 960w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_1440.png 1440w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_1920.png 1920w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_2880.png 2880w" sizes="(max-width: 840px) 100vw, 856px"> <strong>start</strong> — code to modify for this codelab.</li>
<li><img alt="android_studio_folder.png" style="width: 20.00px" src="/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647.png" srcset="https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_36.png 36w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_48.png 48w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_72.png 72w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_96.png 96w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_480.png 480w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_720.png 720w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_856.png 856w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_960.png 960w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_1440.png 1440w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_1920.png 1920w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_2880.png 2880w" sizes="(max-width: 840px) 100vw, 856px"> <strong>finished_code</strong> — the code for the completed codelab. Refer to this module if you run into issues.</li>
<li><img alt="android_studio_folder.png" style="width: 20.00px" src="/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647.png" srcset="https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_36.png 36w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_48.png 48w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_72.png 72w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_96.png 96w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_480.png 480w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_720.png 720w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_856.png 856w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_960.png 960w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_1440.png 1440w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_1920.png 1920w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/a1beacb239657647_2880.png 2880w" sizes="(max-width: 840px) 100vw, 856px"> <strong>sunflower</strong> — supporting app code. We will not make modifications to code in this module.</li>
</ul>
</aside>
<h3 is-upgraded id="frequently-asked-questions" data-text="Frequently asked questions" tabindex="-1">Frequently <strong>asked questions</strong></h3>
<ul>
<li><a href="https://developer.android.com/studio/install" target="_blank">How do I install Android Studio?</a></li>
<li><a href="https://developer.android.com/studio/run/device" target="_blank">How do I set up a device for development?</a></li>
</ul>


        </google-codelab-step>
      
        <google-codelab-step label="Run the starting sample app" duration="2" step="2">
          
          <h2 class="step-title" id="2" data-text="Run the starting sample app" tabindex="-1">
              3. Run the starting sample app
          </h2>
          <p>First, let&#39;s see what the starting sample app looks like. Follow these instructions to open the sample app in Android Studio.</p>
<ol type="1">
<li>If you downloaded the <code translate="no" dir="ltr">kotlin-coroutines</code> zip file, unzip the file.</li>
<li>Open the <code translate="no" dir="ltr">advanced-coroutines-codelab</code> directory in Android Studio.</li>
<li>Make sure <code translate="no" dir="ltr">start</code> is selected in the configuration drop-down.</li>
<li>Click the <strong>Run  </strong><img alt="execute.png" style="width: 20.00px" src="/static/codelabs/advanced-kotlin-coroutines/img/c8b8a080b7ead886.png" srcset="https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/c8b8a080b7ead886_36.png 36w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/c8b8a080b7ead886_48.png 48w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/c8b8a080b7ead886_72.png 72w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/c8b8a080b7ead886_96.png 96w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/c8b8a080b7ead886_480.png 480w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/c8b8a080b7ead886_720.png 720w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/c8b8a080b7ead886_856.png 856w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/c8b8a080b7ead886_960.png 960w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/c8b8a080b7ead886_1440.png 1440w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/c8b8a080b7ead886_1920.png 1920w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/c8b8a080b7ead886_2880.png 2880w" sizes="(max-width: 840px) 100vw, 856px"> button, and either choose an emulated device or connect your Android device. The device must be capable of running Android Lollipop (the minimum supported SDK is 21).</li>
</ol>
<p>When the app first runs, a list of cards appears, each displaying the name and image of a specific plant:</p>
<p class="image-container"><img alt="3d457e66c13f2ef8.png" title="Plant list" style="width: 288.00px" src="/static/codelabs/advanced-kotlin-coroutines/img/3d457e66c13f2ef8.png" srcset="https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/3d457e66c13f2ef8_36.png 36w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/3d457e66c13f2ef8_48.png 48w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/3d457e66c13f2ef8_72.png 72w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/3d457e66c13f2ef8_96.png 96w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/3d457e66c13f2ef8_480.png 480w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/3d457e66c13f2ef8_720.png 720w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/3d457e66c13f2ef8_856.png 856w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/3d457e66c13f2ef8_960.png 960w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/3d457e66c13f2ef8_1440.png 1440w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/3d457e66c13f2ef8_1920.png 1920w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/3d457e66c13f2ef8_2880.png 2880w" sizes="(max-width: 840px) 100vw, 856px"></p>
<p>Each <code translate="no" dir="ltr">Plant</code> has a <code translate="no" dir="ltr">growZoneNumber</code>, an attribute that represents the region where the plant is most likely to thrive. Users can tap the filter icon  <img alt="ee1895257963ae84.png" style="width: 18.00px" src="/static/codelabs/advanced-kotlin-coroutines/img/ee1895257963ae84.png" srcset="https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/ee1895257963ae84_36.png 36w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/ee1895257963ae84_48.png 48w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/ee1895257963ae84_72.png 72w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/ee1895257963ae84_96.png 96w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/ee1895257963ae84_480.png 480w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/ee1895257963ae84_720.png 720w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/ee1895257963ae84_856.png 856w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/ee1895257963ae84_960.png 960w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/ee1895257963ae84_1440.png 1440w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/ee1895257963ae84_1920.png 1920w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/ee1895257963ae84_2880.png 2880w" sizes="(max-width: 840px) 100vw, 856px"> to toggle between showing all plants and plants for a specific grow zone, which is hardcoded to zone 9. Press the filter button a few times to see this in action.</p>
<p class="image-container"><img alt="6d6df01741e0487a.png" title="A filtered list containing Plants from GrowZone 9" style="width: 288.00px" src="/static/codelabs/advanced-kotlin-coroutines/img/6d6df01741e0487a.png" srcset="https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/6d6df01741e0487a_36.png 36w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/6d6df01741e0487a_48.png 48w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/6d6df01741e0487a_72.png 72w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/6d6df01741e0487a_96.png 96w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/6d6df01741e0487a_480.png 480w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/6d6df01741e0487a_720.png 720w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/6d6df01741e0487a_856.png 856w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/6d6df01741e0487a_960.png 960w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/6d6df01741e0487a_1440.png 1440w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/6d6df01741e0487a_1920.png 1920w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/6d6df01741e0487a_2880.png 2880w" sizes="(max-width: 840px) 100vw, 856px"></p>
<h2 is-upgraded id="architecture-overview" data-text="Architecture overview" tabindex="-1">Architecture overview</h2>
<p>This app uses  <a href="https://developer.android.com/topic/libraries/architecture" target="_blank">Architecture Components</a> to separate the UI code in <code translate="no" dir="ltr">MainActivity</code> and <code translate="no" dir="ltr">PlantListFragment</code> from the application logic in <code translate="no" dir="ltr">PlantListViewModel</code>. <code translate="no" dir="ltr">PlantRepository</code> provides a bridge between the <code translate="no" dir="ltr">ViewModel</code> and <code translate="no" dir="ltr">PlantDao</code>, which accesses the <code translate="no" dir="ltr">Room</code> database to return a list of <code translate="no" dir="ltr">Plant</code> objects. The UI then takes this list of plants and displays them in <code translate="no" dir="ltr">RecyclerView</code> grid layout.</p>
<aside class="special"><p><strong>A Repository is a bridge between a ViewModel and the data</strong></p>
<p>In addition to being the bridge, a repository can be accessed by any ViewModel that wants to use its logic.  It can also combine the logic from multiple data sources, which we will be implemented later.</p>
</aside>
<p>Before we start modifying the code, let&#39;s take a quick look at how the data flows from the database to the UI. Here is how the list of plants are loaded in the <code translate="no" dir="ltr">ViewModel</code>:</p>
<h3 is-upgraded id="plantlistviewmodel.kt" data-text="PlantListViewModel.kt" tabindex="-1">PlantListViewModel.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plants</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">LiveData&lt;List&lt;Plant&gt;</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">switchMap</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-k">if</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">==</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">NoGrowZone</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">plants</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">}</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-k">else</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlantsWithGrowZone</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>A <code translate="no" dir="ltr">GrowZone</code> is an inline class that only contains an <code translate="no" dir="ltr">Int</code> representing its zone.  <code translate="no" dir="ltr">NoGrowZone</code> represents the absence of a zone, and is only used for filtering.</p>
<h3 is-upgraded id="plant.kt" data-text="Plant.kt" tabindex="-1">Plant.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">inline</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">class</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nc">GrowZone</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">number</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kt">Int</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">NoGrowZone</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">GrowZone</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-o">-</span><span class="devsite-syntax-m">1</span><span class="devsite-syntax-p">)</span>
</code></pre></devsite-code>
<p>The <code translate="no" dir="ltr">growZone</code> is toggled when the filter button is tapped. We use a  <a href="https://developer.android.com/reference/androidx/lifecycle/Transformations.html#switchMap(androidx.lifecycle.LiveData%3CX%3E,%20androidx.arch.core.util.Function%3CX,%20androidx.lifecycle.LiveData%3CY%3E%3E)" target="_blank"><code translate="no" dir="ltr">switchMap</code></a> to determine the list of plants to return.</p>
<aside class="special"><p>A <code translate="no" dir="ltr">switchMap</code> applies a given function to the input <code translate="no" dir="ltr">LiveData</code> (<code translate="no" dir="ltr">growZone</code> in this case) and returns the transformed result as a <code translate="no" dir="ltr">LiveData</code>.</p>
</aside>
<p>Here is what the repository and Data Access Object (DAO) look like for fetching the plant data from the database:</p>
<h3 is-upgraded id="plantdao.kt" data-text="PlantDao.kt" tabindex="-1">PlantDao.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-nd">@Query</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"SELECT * FROM plants ORDER BY name"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">getPlants</span><span class="devsite-syntax-p">():</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">LiveData&lt;List&lt;Plant&gt;</span>&gt;

<span class="devsite-syntax-nd">@Query</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"SELECT * FROM plants WHERE growZoneNumber = :growZoneNumber ORDER BY name"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">getPlantsWithGrowZoneNumber</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZoneNumber</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kt">Int</span><span class="devsite-syntax-p">):</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">LiveData&lt;List&lt;Plant&gt;</span>&gt;
</code></pre></devsite-code>
<h3 is-upgraded id="plantrepository.kt" data-text="PlantRepository.kt" tabindex="-1">PlantRepository.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plants</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlants</span><span class="devsite-syntax-p">()</span>

<span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">getPlantsWithGrowZone</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">GrowZone</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlantsWithGrowZoneNumber</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">number</span><span class="devsite-syntax-p">)</span>
</code></pre></devsite-code>
<p>While most of the code modifications are in <code translate="no" dir="ltr">PlantListViewModel</code> and <code translate="no" dir="ltr">PlantRepository</code>, it&#39;s a good idea to take a moment to familiarize yourself with the structure of the project, focusing on how the plant data surfaces through the various layers from the database to the <code translate="no" dir="ltr">Fragment</code>. In the next step, we&#39;ll modify the code to add custom sorting using the <code translate="no" dir="ltr">LiveData</code> builder.</p>
<aside class="special"><ul>
<li>This codelab&#39;s app is based on the  <a href="https://github.com/android/sunflower" target="_blank">Android Sunflower</a> open source sample</li>
<li><strong>Fun fact</strong>: the <code translate="no" dir="ltr">growZoneNumber</code> is loosely based on the United States Department of Agriculture&#39;s  <a href="https://planthardiness.ars.usda.gov/PHZMWeb/" target="_blank">Plant Hardiness Zone Map</a></li>
</ul>
</aside>


        </google-codelab-step>
      
        <google-codelab-step label="Plants with custom sorting" duration="0" step="3">
          
          <h2 class="step-title" id="3" data-text="Plants with custom sorting" tabindex="-1">
              4. Plants with custom sorting
          </h2>
          <p>The list of plants are currently displayed in alphabetical order, but we want to change the order of this list by listing certain plants first, and then the rest in alphabetical order.  This is similar to shopping apps displaying sponsored results at the top of a list of items available for purchase. Our product team wants the ability to change the sort order dynamically without shipping a new version of the app, so we&#39;ll fetch the list of plants to sort first from the backend.</p>
<p>Here&#39;s what the app will look like with custom sorting:</p>
<p class="image-container"><img alt="1b9cc46d7c237b7b.png" style="width: 288.00px" src="/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b.png" srcset="https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_36.png 36w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_48.png 48w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_72.png 72w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_96.png 96w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_480.png 480w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_720.png 720w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_856.png 856w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_960.png 960w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_1440.png 1440w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_1920.png 1920w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_2880.png 2880w" sizes="(max-width: 840px) 100vw, 856px"></p>
<p>The custom sort order list consists of these four plants: Orange, Sunflower, Grape, and Avocado.  Notice how they appear first in the list, then followed by the rest of the plants in alphabetical order.</p>
<p>Now if the filter button is pressed (and only <code translate="no" dir="ltr">GrowZone</code> 9 plants are displayed), the Sunflower disappears from the list since its <code translate="no" dir="ltr">GrowZone</code> is not 9.  The other three plants in the custom sort list are in <code translate="no" dir="ltr">GrowZone</code> 9, so they&#39;ll remain at the top of the list.  The only other plant in <code translate="no" dir="ltr">GrowZone</code> 9 is the Tomato, which appears last in this list.</p>
<p class="image-container"><img alt="1a622557d39c6992.png" style="width: 288.00px" src="/static/codelabs/advanced-kotlin-coroutines/img/1a622557d39c6992.png" srcset="https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1a622557d39c6992_36.png 36w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1a622557d39c6992_48.png 48w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1a622557d39c6992_72.png 72w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1a622557d39c6992_96.png 96w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1a622557d39c6992_480.png 480w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1a622557d39c6992_720.png 720w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1a622557d39c6992_856.png 856w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1a622557d39c6992_960.png 960w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1a622557d39c6992_1440.png 1440w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1a622557d39c6992_1920.png 1920w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1a622557d39c6992_2880.png 2880w" sizes="(max-width: 840px) 100vw, 856px"></p>
<p>Let&#39;s start writing code to implement the custom sort.</p>


        </google-codelab-step>
      
        <google-codelab-step label="Fetching sort order" duration="0" step="4">
          
          <h2 class="step-title" id="4" data-text="Fetching sort order" tabindex="-1">
              5. Fetching sort order
          </h2>
          <p>We&#39;ll begin by writing a suspending function to fetch the custom sort order from the network and then cache it in memory.</p>
<p>Add the following to <code translate="no" dir="ltr">PlantRepository</code>:</p>
<h3 is-upgraded id="plantrepository.kt_1" data-text="PlantRepository.kt" tabindex="-1">PlantRepository.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">private</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">var</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plantsListSortOrderCache</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">CacheOnSuccess</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">onErrorFallback</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">listOf&lt;String&gt;</span><span class="devsite-syntax-p">()</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">})</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-n">plantService</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">customPlantSortOrder</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p><code translate="no" dir="ltr">plantsListSortOrderCache</code> is used as the in-memory cache for the custom sort order. It will fallback to an empty list if there&#39;s a network error, so that our app can still display data even if the sorting order isn&#39;t fetched.</p>
<p>This code uses the <code translate="no" dir="ltr">CacheOnSuccess</code> utility class provided in the <code translate="no" dir="ltr">sunflower</code> module to handle caching. By abstracting away the details of implementing caching like this, the application code can be more straightforward. Since <code translate="no" dir="ltr">CacheOnSuccess</code> is already well tested, we don&#39;t need to write as many tests for our repository to ensure the correct behavior. It&#39;s a good idea to introduce similar higher-level abstractions in your code when using <code translate="no" dir="ltr">kotlinx-coroutines</code>.</p>
<p>Now let&#39;s incorporate some logic to apply the sort to a list of plants.</p>
<p>Add the following to <code translate="no" dir="ltr">PlantRepository:</code></p>
<h3 is-upgraded id="plantrepository.kt_2" data-text="PlantRepository.kt" tabindex="-1">PlantRepository.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">private</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">List&lt;Plant&gt;</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-nf">applySort</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">customSortOrder</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">List&lt;String&gt;</span><span class="devsite-syntax-p">):</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">List&lt;Plant&gt;</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-k">return</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">sortedBy</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plant</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">positionForItem</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">customSortOrder</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">indexOf</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">plant</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">plantId</span><span class="devsite-syntax-p">).</span><span class="devsite-syntax-na">let</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">order</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">            </span><span class="devsite-syntax-k">if</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">order</span><span class="devsite-syntax-w"> &gt; </span><span class="devsite-syntax-o">-</span><span class="devsite-syntax-m">1</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">order</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-k">else</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kt">Int</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">MAX_VALUE</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-n">ComparablePair</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">positionForItem</span><span class="devsite-syntax-p">,</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plant</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">name</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>This extension function will rearrange the list, placing <code translate="no" dir="ltr">Plants</code> that are in the <code translate="no" dir="ltr">customSortOrder</code> at the front of the list.</p>


        </google-codelab-step>
      
        <google-codelab-step label="Building logic with LiveData" duration="4" step="5">
          
          <h2 class="step-title" id="5" data-text="Building logic with LiveData" tabindex="-1">
              6. Building logic with LiveData
          </h2>
          <p>Now that the sorting logic is in place, replace the code for <code translate="no" dir="ltr">plants</code> and <code translate="no" dir="ltr">getPlantsWithGrowZone</code> with the <code translate="no" dir="ltr">LiveData</code>  <a href="https://developer.android.com/topic/libraries/architecture/coroutines#livedata" target="_blank">builder</a> below:</p>
<h3 is-upgraded id="plantrepository.kt_3" data-text="PlantRepository.kt" tabindex="-1">PlantRepository.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plants</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">LiveData&lt;List&lt;Plant&gt;</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">liveData&lt;List&lt;Plant&gt;</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plantsLiveData</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlants</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">customSortOrder</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantsListSortOrderCache</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getOrAwait</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">emitSource</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">plantsLiveData</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">map</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-n">plantList</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantList</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">applySort</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">customSortOrder</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-p">})</span>
<span class="devsite-syntax-p">}</span>

<span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">getPlantsWithGrowZone</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">GrowZone</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">liveData</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plantsGrowZoneLiveData</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlantsWithGrowZoneNumber</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">number</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">customSortOrder</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantsListSortOrderCache</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getOrAwait</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">emitSource</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">plantsGrowZoneLiveData</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">map</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantList</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;<span class="devsite-syntax-w"> </span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-n">plantList</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">applySort</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">customSortOrder</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">})</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>Now if you run the app, the custom sorted plant list should appear:</p>
<p class="image-container"><img alt="1b9cc46d7c237b7b.png" style="width: 288.00px" src="/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b.png" srcset="https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_36.png 36w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_48.png 48w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_72.png 72w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_96.png 96w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_480.png 480w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_720.png 720w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_856.png 856w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_960.png 960w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_1440.png 1440w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_1920.png 1920w,https://developer.android.com/static/codelabs/advanced-kotlin-coroutines/img/1b9cc46d7c237b7b_2880.png 2880w" sizes="(max-width: 840px) 100vw, 856px"></p>
<p>The <code translate="no" dir="ltr">LiveData</code> builder allows us to calculate values asynchronously, as <code translate="no" dir="ltr">liveData</code> is backed by coroutines.  Here we have a suspend function to fetch a <code translate="no" dir="ltr">LiveData</code> list of plants from the database, while also calling a suspend function to get the custom sort order.  We then combine these two values to sort the list of plants and return the value, all within the builder.</p>
<aside class="special"><p>You can emit multiple values from a <code translate="no" dir="ltr">LiveData</code> by calling the <code translate="no" dir="ltr">emitSource()</code> function whenever you want to emit a new value. Note that each call to <code translate="no" dir="ltr">emitSource()</code> removes the previously-added source.</p>
</aside>
<p>The coroutine starts execution when it is observed, and is cancelled when the coroutine successfully finishes or if either the database or network call fails.</p>
<aside class="special"><p>If any of the suspend function calls fail, the entire block is canceled and not restarted, which helps avoid leaks.</p>
</aside>
<p>In the next step, we&#39;ll explore a variation of <code translate="no" dir="ltr">getPlantsWithGrowZone</code> using a  <a href="https://developer.android.com/reference/androidx/lifecycle/Transformations" target="_blank">Transformation</a>.</p>


        </google-codelab-step>
      
        <google-codelab-step label="liveData: Modifying values" duration="6" step="6">
          
          <h2 class="step-title" id="6" data-text="liveData: Modifying values" tabindex="-1">
              7. liveData: Modifying values
          </h2>
          <p>We&#39;ll now modify <code translate="no" dir="ltr">PlantRepository</code> to implement a suspending  <a href="https://developer.android.com/reference/androidx/lifecycle/Transformations" target="_blank">transform</a> as each value is processed, learning how to build complex async transforms in <code translate="no" dir="ltr">LiveData</code>.  As a prerequisite, let&#39;s create a version of the sorting algorithm that&#39;s safe to use on the main thread. We can use  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/with-context.html" target="_blank"><code translate="no" dir="ltr">withContext</code></a> to switch to another dispatcher just for the lambda and then resume on the dispatcher we started with.</p>
<p>Add the following to <code translate="no" dir="ltr">PlantRepository</code>:</p>
<h3 is-upgraded id="plantrepository.kt_4" data-text="PlantRepository.kt" tabindex="-1"><strong>PlantRepository.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-nd">@AnyThread</span>
<span class="devsite-syntax-kd">suspend</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">List&lt;Plant&gt;</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-nf">applyMainSafeSort</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">customSortOrder</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">List&lt;String&gt;</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">withContext</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">defaultDispatcher</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-k">this</span><span class="devsite-syntax-nd">@applyMainSafeSort.applySort</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">customSortOrder</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<aside class="special"><p>To switch between any dispatcher, coroutines uses  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/with-context.html" target="_blank"><code translate="no" dir="ltr">withContext</code></a>. Calling <code translate="no" dir="ltr">withContext</code> switches to the other dispatcher <em>just for the lambda</em> then comes back to the dispatcher that called it with the result of that lambda.</p>
<p>By default, Kotlin coroutines provides three Dispatchers:  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-dispatchers/-main.html" target="_blank"><code translate="no" dir="ltr">Main</code></a>,  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-dispatchers/-i-o.html" target="_blank"><code translate="no" dir="ltr">IO</code></a>, and  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-dispatchers/-default.html" target="_blank"><code translate="no" dir="ltr">Default</code></a>. The IO dispatcher is optimized for IO work like reading from the network or disk, while the Default dispatcher is optimized for CPU intensive tasks.</p>
</aside>
<p>We can then use this new main-safe sort with the <code translate="no" dir="ltr">LiveData</code> builder.  Update the block to use a <code translate="no" dir="ltr">switchMap</code>, which will let you point to a new <code translate="no" dir="ltr">LiveData</code> every time a new value is received.</p>
<h3 is-upgraded id="plantrepository.kt_5" data-text="PlantRepository.kt" tabindex="-1"><strong>PlantRepository.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">getPlantsWithGrowZone</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">GrowZone</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlantsWithGrowZoneNumber</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">number</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">switchMap</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantList</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">           </span><span class="devsite-syntax-n">liveData</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">               </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">customSortOrder</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantsListSortOrderCache</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getOrAwait</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">               </span><span class="devsite-syntax-n">emit</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">plantList</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">applyMainSafeSort</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">customSortOrder</span><span class="devsite-syntax-p">))</span>
<span class="devsite-syntax-w">           </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>Compared to the previous version, once the custom sort order is received from the network, it can then be used with the new main-safe <code translate="no" dir="ltr">applyMainSafeSort</code>.  This result is then emitted to the <code translate="no" dir="ltr">switchMap</code> as the new value returned by <code translate="no" dir="ltr">getPlantsWithGrowZone</code>.</p>
<p>Similar to <code translate="no" dir="ltr">plants</code> LiveData above, the coroutine starts execution when it is observed and is terminated either on completion or if either the database or network call fails.  The difference here is that it&#39;s safe to make the network call in the map since it is cached.</p>
<p>Now let&#39;s take a look at how this code is implemented with Flow, and compare the implementations.</p>


        </google-codelab-step>
      
        <google-codelab-step label="Introducing Flow" duration="7" step="7">
          
          <h2 class="step-title" id="7" data-text="Introducing Flow" tabindex="-1">
              8. Introducing Flow
          </h2>
          <p>We&#39;re going to build the same logic using  <a href="https://kotlinlang.org/docs/reference/coroutines/flow.html" target="_blank">Flow</a> from <code translate="no" dir="ltr">kotlinx-coroutines</code>. Before we do that, let&#39;s take a look at what a flow is and how you can incorporate it into your app.</p>
<p>A flow is an asynchronous version of a  <a href="https://kotlinlang.org/docs/reference/sequences.html" target="_blank">Sequence</a>, a type of collection whose values are lazily produced. Just like a sequence, a flow produces each value on-demand whenever the value is needed, and flows can contain an infinite number of values.</p>
<p>So, why did Kotlin introduce a new <code translate="no" dir="ltr">Flow</code> type, and how is it different than a regular sequence? The answer lies in the magic of asynchronicity. <code translate="no" dir="ltr">Flow</code> includes full support for coroutines. That means you can build, transform, and consume a <code translate="no" dir="ltr">Flow</code> using coroutines. You can also control concurrency, which means coordinating the execution of several coroutines declaratively with <code translate="no" dir="ltr">Flow</code>.</p>
<p>This opens up a lot of exciting possibilities.</p>
<aside class="special"><p><strong>A Flow is an async sequence of values</strong></p>
<p><code translate="no" dir="ltr">Flow</code> produces values one at a time (instead of all at once) that can generate values from <em>async</em> operations like network requests, database calls, or other <em>async</em> code. It supports coroutines throughout its API, so you can transform a flow using coroutines as well!</p>
</aside>
<p><code translate="no" dir="ltr">Flow</code> can be used in a fully-reactive programming style. If you&#39;ve used something like <code translate="no" dir="ltr">RxJava</code> before, <code translate="no" dir="ltr">Flow</code> provides similar functionality. Application logic can be expressed succinctly by transforming a flow with functional operators such as  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/map.html" target="_blank"><code translate="no" dir="ltr">map</code></a>,  <a href="https://kotlinlang.org/docs/reference/coroutines/flow.html#flatmaplatest" target="_blank"><code translate="no" dir="ltr">flatMapLatest</code></a>,  <a href="https://kotlinlang.org/docs/reference/coroutines/flow.html#combine" target="_blank"><code translate="no" dir="ltr">combine</code></a>, and so on.</p>
<p><code translate="no" dir="ltr">Flow</code> also supports suspending functions on most operators. This lets you do sequential async tasks inside an operator like <code translate="no" dir="ltr">map</code>. By using suspending operations inside of a flow, it often results in shorter and easier to read code than the equivalent code in a fully-reactive style.</p>
<p>In this codelab, we&#39;re going to explore using both approaches.</p>
<h2 is-upgraded id="how-does-flow-run" data-text="How does flow run" tabindex="-1"><strong>How does flow run</strong></h2>
<p>To get used to how Flow produces values on demand (or lazily), take a look at the following flow that emits the values <code translate="no" dir="ltr">(1, 2, 3)</code> and prints before, during, and after each item is produced.</p>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">makeFlow</span><span class="devsite-syntax-p">()</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">flow</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">println</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"sending first value"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">emit</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-m">1</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">println</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"first value collected, sending another value"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">emit</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-m">2</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">println</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"second value collected, sending a third value"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">emit</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-m">3</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">println</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"done"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-p">}</span>

<span class="devsite-syntax-n">scope</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">launch</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">makeFlow</span><span class="devsite-syntax-p">().</span><span class="devsite-syntax-na">collect</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-n">println</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"got </span><span class="devsite-syntax-si">$</span><span class="devsite-syntax-n">value</span><span class="devsite-syntax-s">"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">println</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"flow is completed"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>If you run this, it produces this output:</p>
<div></div><devsite-code><pre translate="no" dir="ltr" is-upgraded>sending first value
got 1
first value collected, sending another value
got 2
second value collected, sending a third value
got 3
done
flow is completed
</pre></devsite-code>
<p>You can see how execution bounces between the  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/collect.html" target="_blank"><code translate="no" dir="ltr">collect</code></a> lambda and the  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/flow.html" target="_blank"><code translate="no" dir="ltr">flow</code></a> builder. Every time the flow builder calls  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-flow-collector/emit.html" target="_blank"><code translate="no" dir="ltr">emit</code></a>, it <code translate="no" dir="ltr">suspends</code> until the element is completely processed. Then, when another value is requested from the flow, it <code translate="no" dir="ltr">resumes</code> from where it left off until it calls emit again. When the <code translate="no" dir="ltr">flow</code> builder completes, <code translate="no" dir="ltr">collect</code> can now finish and the calling block prints &#34;flow is completed.&#34;</p>
<p>The call to <code translate="no" dir="ltr">collect</code> is very important. <code translate="no" dir="ltr">Flow</code> uses suspending operators like <code translate="no" dir="ltr">collect</code> instead of exposing an <code translate="no" dir="ltr">Iterator</code> interface so that it always knows when it&#39;s being actively consumed. More importantly, it knows when the caller can&#39;t request any more values so it can cleanup resources.</p>
<aside class="special"><p><code translate="no" dir="ltr">Flow</code> is built from the ground up using coroutines. By using the <code translate="no" dir="ltr">suspend</code> and <code translate="no" dir="ltr">resume</code> mechanism of coroutines, they can synchronize the execution of the producer (<code translate="no" dir="ltr">flow</code>) with the consumer (<code translate="no" dir="ltr">collect</code>).</p>
<p>If you&#39;ve used reactive streams and are familiar with the concept of backpressure, it is implemented in <code translate="no" dir="ltr">Flow</code> by suspending a coroutine.</p>
</aside>
<h2 is-upgraded id="when-does-a-flow-run" data-text="When does a flow run" tabindex="-1"><strong>When does a flow run</strong></h2>
<p>The <code translate="no" dir="ltr">Flow</code> in the above example starts running when the <code translate="no" dir="ltr">collect</code> operator runs. Creating a new <code translate="no" dir="ltr">Flow</code> by calling the <code translate="no" dir="ltr">flow</code> builder or other APIs does not cause any work to execute. The suspending operator <code translate="no" dir="ltr">collect</code> is called a <strong>terminal operator</strong> in <code translate="no" dir="ltr">Flow</code>. There are other suspending terminal operators such as  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/to-list.html" target="_blank"><code translate="no" dir="ltr">toList</code></a>,  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/first.html" target="_blank"><code translate="no" dir="ltr">first</code></a> and  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/single.html" target="_blank"><code translate="no" dir="ltr">single</code></a> shipped with <code translate="no" dir="ltr">kotlinx-coroutines</code>, and you can build your own.</p>
<p>By default <code translate="no" dir="ltr">Flow</code> will execute<code translate="no" dir="ltr">:</code></p>
<ul>
<li>Every time a terminal operator is applied (and each new invocation is independent from any previously started ones)</li>
<li>Until the coroutine it is running in is cancelled</li>
<li>When the last value has been fully processed, and another value has been requested</li>
</ul>
<aside class="warning"><p>These rules are the <em>default</em> behavior of <code translate="no" dir="ltr">Flow</code> and it is possible to make a <code translate="no" dir="ltr">Flow</code> that has shared state with previous runs, doesn&#39;t restart for every terminal operator, and executes independently of collection with built-in or custom transformations of a <code translate="no" dir="ltr">Flow</code>.</p>
</aside>
<aside class="special"><p>Executing a <code translate="no" dir="ltr">Flow</code> is called <strong>collecting</strong> a flow. By default, a <code translate="no" dir="ltr">Flow</code> will not do anything until it has been <strong>collected</strong> which means applying any <strong>terminal operator</strong>.</p>
<p><code translate="no" dir="ltr">myFlow.toList() // toList collects this flow and adds the values to a List</code></p>
<p>We also say an individual value is <strong>collected</strong> from the <code translate="no" dir="ltr">Flow</code> by a  terminal operator.</p>
<p><code translate="no" dir="ltr">myFlow.collect { item -&gt; println("$item has been collected") }</code></p>
</aside>
<p>Because of these rules, a <code translate="no" dir="ltr">Flow</code> can participate in structured concurrency, and it&#39;s safe to start long-running coroutines from a <code translate="no" dir="ltr">Flow</code>. There&#39;s no chance a <code translate="no" dir="ltr">Flow</code> will leak resources, since they&#39;re always cleaned up using  <a href="https://kotlinlang.org/docs/reference/coroutines/cancellation-and-timeouts.html#cancellation-is-cooperative" target="_blank">coroutine cooperative cancellation rules</a> when the caller is cancelled.</p>
<p>Lets modify the flow above to only look at the first two elements using the  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/take.html" target="_blank"><code translate="no" dir="ltr">take</code></a> operator, then collect it twice.</p>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-n">scope</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">launch</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">repeatableFlow</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">makeFlow</span><span class="devsite-syntax-p">().</span><span class="devsite-syntax-na">take</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-m">2</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w">  </span><span class="devsite-syntax-c1">// we only care about the first two elements</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">println</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"first collection"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">repeatableFlow</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">collect</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">println</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"collecting again"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">repeatableFlow</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">collect</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">println</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"second collection completed"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>Running this code, you&#39;ll see this output:</p>
<div></div><devsite-code><pre translate="no" dir="ltr" is-upgraded>first collection
sending first value
first value collected, sending another value
collecting again
sending first value
first value collected, sending another value
second collection completed
</pre></devsite-code>
<p>The <code translate="no" dir="ltr">flow</code> lambda starts from the top each time <code translate="no" dir="ltr">collect</code> is called. This is important if the flow performed expensive work like making a network request. Also, since we applied the  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/take.html" target="_blank"><code translate="no" dir="ltr">take(2)</code></a> operator, the flow will only produce two values. It will not resume the flow lambda again after the second call to <code translate="no" dir="ltr">emit</code>, so the line &#34;second value collected...&#34; will never print.</p>
<aside class="special"><p>By default, a <code translate="no" dir="ltr">Flow</code> will restart from the top every time a terminal operator is applied. This is important if the <code translate="no" dir="ltr">Flow</code> performs expensive work, such as making a network request.</p>
</aside>


        </google-codelab-step>
      
        <google-codelab-step label="Going async with flow" duration="3" step="8">
          
          <h2 class="step-title" id="8" data-text="Going async with flow" tabindex="-1">
              9. Going async with flow
          </h2>
          <p>OK, so <code translate="no" dir="ltr">Flow</code> is lazy like a <code translate="no" dir="ltr">Sequence</code>, but how is it also async? Let&#39;s take a look at an example of an async sequence–observing changes to a database.</p>
<p>In this example, we need to coordinate data produced on a database thread pool with observers that live on another thread such as the main or UI thread. And, since we&#39;ll be emitting results repeatedly as the data changes, this scenario is a natural fit for an async sequence pattern.</p>
<p>Imagine you&#39;re tasked with writing the  <a href="https://developer.android.com/topic/libraries/architecture/room" target="_blank"><code translate="no" dir="ltr">Room</code></a> integration for <code translate="no" dir="ltr">Flow</code>. If you started with the existing suspend query support in <code translate="no" dir="ltr">Room</code>, you might write something like this:</p>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-c1">// This code is a simplified version of how Room implements flow</span>
<span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span>&lt;<span class="devsite-syntax-nf">T</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">createFlow</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">query</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">Query</span><span class="devsite-syntax-p">,</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">tables</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">List&lt;Tables&gt;</span><span class="devsite-syntax-p">):</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">Flow&lt;T&gt;</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">flow</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">changeTracker</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">tableChangeTracker</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">tables</span><span class="devsite-syntax-p">)</span>

<span class="devsite-syntax-w">    </span><span class="devsite-syntax-k">while</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-kc">true</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-n">emit</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">suspendQuery</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">query</span><span class="devsite-syntax-p">))</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-n">changeTracker</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">suspendUntilChanged</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>This code relies upon two imaginary suspending functions to generate a <code translate="no" dir="ltr">Flow</code>:</p>
<ul>
<li><code translate="no" dir="ltr">suspendQuery</code> – a main-safe function that runs a regular <code translate="no" dir="ltr">Room</code> suspend query</li>
<li><code translate="no" dir="ltr">suspendUntilChanged</code> – a function that suspends the coroutine until one of the tables changes</li>
</ul>
<p>When collected, the flow initially <code translate="no" dir="ltr">emits</code> the first value of the query. Once that value is processed, the flow resumes and calls <code translate="no" dir="ltr">suspendUntilChanged</code>, which will do as it says–suspend the flow until one of the tables changes. At this point, nothing is happening in the system until one of the tables changes and the flow resumes.</p>
<p>When the flow resumes, it makes another main-safe query, and <code translate="no" dir="ltr">emits</code> the results. This process continues forever in an infinite loop.</p>
<h2 is-upgraded id="flow-and-structured-concurrency" data-text="Flow and structured concurrency" tabindex="-1"><strong>Flow and structured concurrency</strong></h2>
<p>But wait–we don&#39;t want to leak work! The coroutine isn&#39;t very expensive by itself, but it repeatedly wakes itself up to perform a database query. That&#39;s a pretty expensive thing to leak.</p>
<p>Even though we&#39;ve created an infinite loop, <code translate="no" dir="ltr">Flow</code> helps us out by supporting structured concurrency.</p>
<p>The only way to consume values or iterate over a flow is to use a terminal operator. Because all terminal operators are suspend functions, the work is bound to the lifetime of the scope that calls them. When the scope is cancelled, the flow will automatically cancel itself using the regular  <a href="https://kotlinlang.org/docs/reference/coroutines/cancellation-and-timeouts.html#cancellation-is-cooperative" target="_blank">coroutine cooperative cancellation rules</a>. So, even though we&#39;ve written an infinite loop in our flow builder, we can safely consume it without leaks due to structured concurrency.</p>
<aside class="special"><p><strong>Flow supports structured concurrency</strong></p>
<p>Because a flow allows you to consume values only with terminal operators, it can support structured concurrency.</p>
<p>When the consumer of a flow is cancelled, the entire <code translate="no" dir="ltr">Flow</code> is cancelled. Due to structured concurrency, it is impossible to leak a coroutine from an intermediate step</p>
</aside>


        </google-codelab-step>
      
        <google-codelab-step label="Using Flow with Room" duration="6" step="9">
          
          <h2 class="step-title" id="9" data-text="Using Flow with Room" tabindex="-1">
              10. Using Flow with Room
          </h2>
          <p>In this step, you learn how to use <code translate="no" dir="ltr">Flow</code> with  <a href="https://d.android.com/room" target="_blank"><code translate="no" dir="ltr">Room</code></a> and wire it up to the UI.</p>
<p>This step is common for many usages of <code translate="no" dir="ltr">Flow</code>. When used this way, the <code translate="no" dir="ltr">Flow</code> from <code translate="no" dir="ltr">Room</code> operates as an observable database query similar to a <code translate="no" dir="ltr">LiveData</code>.</p>
<h2 is-upgraded id="update-the-dao" data-text="Update the Dao" tabindex="-1"><strong>Update the Dao</strong></h2>
<p>To get started, open up <code translate="no" dir="ltr">PlantDao.kt</code>, and add two new queries that return <code translate="no" dir="ltr">Flow&lt;List&lt;Plant&gt;&gt;</code>:</p>
<h3 is-upgraded id="plantdao.kt_1" data-text="PlantDao.kt" tabindex="-1"><strong>PlantDao.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-nd">@Query</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"SELECT * from plants ORDER BY name"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">getPlantsFlow</span><span class="devsite-syntax-p">():</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">Flow&lt;List&lt;Plant&gt;</span>&gt;

<span class="devsite-syntax-nd">@Query</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-s">"SELECT * from plants WHERE growZoneNumber = :growZoneNumber ORDER BY name"</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">getPlantsWithGrowZoneNumberFlow</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZoneNumber</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kt">Int</span><span class="devsite-syntax-p">):</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">Flow&lt;List&lt;Plant&gt;</span>&gt;
</code></pre></devsite-code>
<p>Note that except for the return types, these functions are identical to the <code translate="no" dir="ltr">LiveData</code> versions. But, we&#39;ll develop them side-by-side to compare them.</p>
<aside class="special"><p>In this codelab, we&#39;re going to build the same database transform using the <code translate="no" dir="ltr">LiveData</code> builder and <code translate="no" dir="ltr">Flow</code>. In a production app, you would only include one of these, but it&#39;s useful to compare them to each other to see how they work.</p>
</aside>
<p>By specifying a <code translate="no" dir="ltr">Flow</code> return type, <code translate="no" dir="ltr">Room</code> executes the query with the following characteristics:</p>
<ul>
<li><strong>Main-safety –</strong> Queries with a <code translate="no" dir="ltr">Flow</code> return type always run on the <code translate="no" dir="ltr">Room</code> executors, so they are always main-safe. You don&#39;t need to do anything in your code to make them run off the main thread.</li>
<li><strong>Observes changes – </strong><code translate="no" dir="ltr">Room</code> automatically observes changes and emits new values to the flow.</li>
<li><strong>Async sequence – </strong><code translate="no" dir="ltr">Flow</code> emits the entire query result on each change, and it won&#39;t introduce any buffers. If you return a <code translate="no" dir="ltr">Flow&lt;List&lt;T&gt;&gt;</code>, the flow emits a <code translate="no" dir="ltr">List&lt;T&gt;</code> that contains all rows from the query result. It will execute just like a sequence – emitting one query result at a time and suspending until it is asked for the next one.</li>
<li><strong>Cancellable –</strong> When the scope that&#39;s collecting these flows is cancelled, <code translate="no" dir="ltr">Room</code> cancels observing this query.</li>
</ul>
<p>Put together, this makes <code translate="no" dir="ltr">Flow</code> a great return type for observing the database from the UI layer.</p>
<h2 is-upgraded id="update-the-repository" data-text="Update the repository" tabindex="-1"><strong>Update the repository</strong></h2>
<p>To continue wiring up the new return values to the UI, open up <code translate="no" dir="ltr">PlantRepository.kt</code>, and add the following code:</p>
<h3 is-upgraded id="plantrepository.kt_6" data-text="PlantRepository.kt" tabindex="-1"><strong>PlantRepository.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plantsFlow</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">Flow&lt;List&lt;Plant&gt;</span>&gt;
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-k">get</span><span class="devsite-syntax-p">()</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlantsFlow</span><span class="devsite-syntax-p">()</span>

<span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">getPlantsWithGrowZoneFlow</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZoneNumber</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">GrowZone</span><span class="devsite-syntax-p">):</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">Flow&lt;List&lt;Plant&gt;</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-k">return</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlantsWithGrowZoneNumberFlow</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZoneNumber</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">number</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>For now, we&#39;re just passing the <code translate="no" dir="ltr">Flow</code> values through to the caller. This is exactly the same as when we started this codelab with passing the <code translate="no" dir="ltr">LiveData</code> through to the <code translate="no" dir="ltr">ViewModel</code>.</p>
<h2 is-upgraded id="update-the-viewmodel" data-text="Update the ViewModel" tabindex="-1">Update the ViewModel</h2>
<p>In <code translate="no" dir="ltr">PlantListViewModel.kt</code>, let&#39;s start simple and just expose the <code translate="no" dir="ltr">plantsFlow</code>. We&#39;ll come back and add the grow zone toggle to the flow version in the next few steps.</p>
<h3 is-upgraded id="plantlistviewmodel.kt_1" data-text="PlantListViewModel.kt" tabindex="-1">PlantListViewModel.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-c1">// add a new property to plantListViewModel</span>

<span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plantsUsingFlow</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">LiveData&lt;List&lt;Plant&gt;</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">plantsFlow</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">asLiveData</span><span class="devsite-syntax-p">()</span>
</code></pre></devsite-code>
<p>Again, we&#39;ll keep the <code translate="no" dir="ltr">LiveData</code> version (<code translate="no" dir="ltr">val plants</code>) around for comparison as we go.</p>
<p>Since we want to keep <code translate="no" dir="ltr">LiveData</code> in the UI layer for this codelab, we&#39;ll use the <code translate="no" dir="ltr">asLiveData</code> extension function to convert our <code translate="no" dir="ltr">Flow</code> into a <code translate="no" dir="ltr">LiveData</code>.  Just like the <code translate="no" dir="ltr">LiveData</code> builder, this adds a configurable timeout to the <code translate="no" dir="ltr">LiveData</code> generated. This is nice because it keeps us from restarting our query every time the configuration changes (such as from device rotation).</p>
<aside class="special"><p>The  <a href="https://developer.android.com/reference/kotlin/androidx/lifecycle/package-summary#aslivedata" target="_blank"><code translate="no" dir="ltr">asLiveData</code></a> operator converts a <code translate="no" dir="ltr">Flow</code> into a <code translate="no" dir="ltr">LiveData</code> with a configurable timeout.</p>
<p>Just like the <code translate="no" dir="ltr">liveData</code> builder, the timeout will help the <code translate="no" dir="ltr">Flow</code> survive restart. If another screen observes before the timeout, the <code translate="no" dir="ltr">Flow</code> won&#39;t be cancelled.</p>
</aside>
<p>Since flow offers main-safety and the ability to cancel, you can choose to pass the <code translate="no" dir="ltr">Flow</code> all the way through to the UI layer without converting it to a <code translate="no" dir="ltr">LiveData</code>. However, for this codelab we will stick to using <code translate="no" dir="ltr">LiveData</code> in the UI layer.</p>
<p>Also in the <code translate="no" dir="ltr">ViewModel</code>, add a cache update to the <code translate="no" dir="ltr">init</code> block. This step is optional for now, but if you clear your cache and don&#39;t add this call, you will not see any data in the app.</p>
<h3 is-upgraded id="plantlistviewmodel.kt_2" data-text="PlantListViewModel.kt" tabindex="-1"><strong>PlantListViewModel.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-k">init</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">clearGrowZoneNumber</span><span class="devsite-syntax-p">()</span><span class="devsite-syntax-w">  </span><span class="devsite-syntax-c1">// keep this</span>

<span class="devsite-syntax-w">    </span><span class="devsite-syntax-c1">// fetch the full plant list</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">launchDataLoad</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">tryUpdateRecentPlantsCache</span><span class="devsite-syntax-p">()</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<h2 is-upgraded id="update-the-fragment" data-text="Update the Fragment" tabindex="-1"><strong>Update the Fragment</strong></h2>
<p>Open <code translate="no" dir="ltr">PlantListFragment.kt</code>, and change the <code translate="no" dir="ltr">subscribeUi</code> function to point to our new <code translate="no" dir="ltr">plantsUsingFlow</code> <code translate="no" dir="ltr">LiveData</code>.</p>
<h3 is-upgraded id="plantlistfragment.kt" data-text="PlantListFragment.kt" tabindex="-1"><strong>PlantListFragment.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">private</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">subscribeUi</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">adapter</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">PlantAdapter</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">viewModel</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">plantsUsingFlow</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">observe</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">viewLifecycleOwner</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plants</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-n">adapter</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">submitList</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">plants</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<h2 is-upgraded id="run-the-app-with-flow" data-text="Run the app with Flow" tabindex="-1"><strong>Run the app with Flow</strong></h2>
<p>If you run the app again, you should see that you&#39;re now loading the data using <code translate="no" dir="ltr">Flow</code>! Since we haven&#39;t implemented the <code translate="no" dir="ltr">switchMap</code> yet, the filter option doesn&#39;t do anything.</p>
<p>In the next step we&#39;ll take a look at transforming the data in a <code translate="no" dir="ltr">Flow</code>.</p>


        </google-codelab-step>
      
        <google-codelab-step label="Combining flows declaratively" duration="8" step="10">
          
          <h2 class="step-title" id="10" data-text="Combining flows declaratively" tabindex="-1">
              11. Combining flows declaratively
          </h2>
          <p>In this step, you&#39;ll apply the sort order to <code translate="no" dir="ltr">plantsFlow</code>. We&#39;ll do this using the <em>declarative</em> API of <code translate="no" dir="ltr">flow</code>.</p>
<aside class="special"><p><strong>What is declarative?</strong></p>
<p>Declarative is an API style that means describing what your program should do instead of how to do it. One of the more commonly known declarative languages is SQL, which allows developers to express what they would like the database to query instead of how to perform the query.</p>
</aside>
<p>By using transforms like <code translate="no" dir="ltr">map</code>, <code translate="no" dir="ltr">combine</code>, or <code translate="no" dir="ltr">mapLatest</code>, we can express how we would like to transform each element as it moves through the flow declaratively. It even lets us express concurrency declaratively,  which can really simplify code. In this section, you&#39;ll see how you can use operators to tell <code translate="no" dir="ltr">Flow</code> to launch two coroutines and combine their results declaratively.</p>
<p>To get started, open up <code translate="no" dir="ltr">PlantRepository.kt</code> and define a new private flow called <code translate="no" dir="ltr">customSortFlow</code>:</p>
<h3 is-upgraded id="plantrepository.kt_7" data-text="PlantRepository.kt" tabindex="-1"><strong>PlantRepository.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">private</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">customSortFlow</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">flow</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">emit</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">plantsListSortOrderCache</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getOrAwait</span><span class="devsite-syntax-p">())</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>This defines a <code translate="no" dir="ltr">Flow</code> that, when collected, will call <code translate="no" dir="ltr">getOrAwait</code> and <code translate="no" dir="ltr">emit</code> the sort order.</p>
<p>Since this flow only emits a single value, you can also build it directly from the <code translate="no" dir="ltr">getOrAwait</code> function using  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/kotlin.-function0/as-flow.html" target="_blank"><code translate="no" dir="ltr">asFlow</code></a>.</p>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-c1">// Create a flow that calls a single function</span>
<span class="devsite-syntax-kd">private</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">customSortFlow</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantsListSortOrderCache</span><span class="devsite-syntax-o">::</span><span class="devsite-syntax-n">getOrAwait</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">asFlow</span><span class="devsite-syntax-p">()</span>
</code></pre></devsite-code>
<p>This code creates a new <code translate="no" dir="ltr">Flow</code> that calls <code translate="no" dir="ltr">getOrAwait</code> and emits the result as its first and only value. It does this by referencing the getOrAwait method using <code translate="no" dir="ltr">::</code> and calling <code translate="no" dir="ltr">asFlow</code> on the resulting <code translate="no" dir="ltr">Function</code> object.</p>
<p>Both of these flows do the same thing, call <code translate="no" dir="ltr">getOrAwait</code> and emit the result before completing.</p>
<h2 is-upgraded id="combine-multiple-flows-declaratively" data-text="Combine multiple flows declaratively" tabindex="-1"><strong>Combine multiple flows declaratively</strong></h2>
<p>Now that we have two flows, <code translate="no" dir="ltr">customSortFlow</code> and <code translate="no" dir="ltr">plantsFlow</code>, let&#39;s combine them declaratively!</p>
<p>Add a  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/combine.html" target="_blank"><code translate="no" dir="ltr">combine</code></a> operator to <code translate="no" dir="ltr">plantsFlow</code>:</p>
<h3 is-upgraded id="plantrepository.kt_8" data-text="PlantRepository.kt" tabindex="-1"><strong>PlantRepository.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">private</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">customSortFlow</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantsListSortOrderCache</span><span class="devsite-syntax-o">::</span><span class="devsite-syntax-n">getOrAwait</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">asFlow</span><span class="devsite-syntax-p">()</span>

<span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plantsFlow</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">Flow&lt;List&lt;Plant&gt;</span>&gt;
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-k">get</span><span class="devsite-syntax-p">()</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlantsFlow</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-c1">// When the result of customSortFlow is available,</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-c1">// this will combine it with the latest value from</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-c1">// the flow above.  Thus, as long as both `plants`</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-c1">// and `sortOrder` are have an initial value (their</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-c1">// flow has emitted at least one value), any change </span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-c1">// to either `plants` or `sortOrder`  will call</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-c1">// `plants.applySort(sortOrder)`.</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">combine</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">customSortFlow</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plants</span><span class="devsite-syntax-p">,</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">sortOrder</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">          </span><span class="devsite-syntax-n">plants</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">applySort</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">sortOrder</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>The <code translate="no" dir="ltr">combine</code> operator combines two flows together. Both flows will run in their own coroutine, then whenever either flow produces a new value the transformation will be called with the latest value from either flow.</p>
<p>By using <code translate="no" dir="ltr">combine</code>, we can combine the cached network lookup with our database query. Both of them will run on different coroutines concurrently. That means that while Room starts the network request, Retrofit can start the network query. Then, as soon as a result is available for both flows, it will call the <code translate="no" dir="ltr">combine</code> lambda where we apply the loaded sort order to the loaded plants.</p>
<aside class="special"><p>The transformation <code translate="no" dir="ltr">combine</code> will launch one coroutine for each flow being combined. This lets you combine two flows concurrently.</p>
<p>It will combine the flows in a &#34;fair&#34; manner, which means that they&#39;ll all get a chance to produce a value (even if one of them is produced by a tight loop).</p>
</aside>
<p>To explore how the <code translate="no" dir="ltr">combine</code> operator works, modify <code translate="no" dir="ltr">customSortFlow</code> to emit twice with a substantial delay in  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/on-start.html" target="_blank"><code translate="no" dir="ltr">onStart</code></a> like this:</p>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-c1">// Create a flow that calls a single function</span>
<span class="devsite-syntax-kd">private</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">customSortFlow</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantsListSortOrderCache</span><span class="devsite-syntax-o">::</span><span class="devsite-syntax-n">getOrAwait</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">asFlow</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">onStart</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-n">emit</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">listOf</span><span class="devsite-syntax-p">())</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-n">delay</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-m">1500</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>The transform <code translate="no" dir="ltr">onStart</code> will happen when an observer listens before other operators, and it can emit placeholder values. So here we&#39;re emitting an empty list, delaying calling <code translate="no" dir="ltr">getOrAwait</code> by 1500ms, then continuing the original flow. If you run the app now, you&#39;ll see that the Room database query returns right away, combining with the empty list (which means it&#39;ll sort alphabetically). Then around 1500ms later, it applies the custom sort.</p>
<p>Before continuing with the codelab, remove the <code translate="no" dir="ltr">onStart</code> transform from the <code translate="no" dir="ltr">customSortFlow</code>.</p>
<aside class="special"><p>You can use <code translate="no" dir="ltr">onStart</code> to run suspending code before a flow runs. It can even <code translate="no" dir="ltr">emit</code> extra values into the flow, so you could use it to emit a <code translate="no" dir="ltr">Loading</code> state on a network request flow.</p>
</aside>
<h2 is-upgraded id="flow-and-main-safety" data-text="Flow and main-safety" tabindex="-1"><strong>Flow and main-safety</strong></h2>
<p><code translate="no" dir="ltr">Flow</code> can call <strong>main-safe</strong> functions, like we&#39;re doing here, and it will preserve the normal main-safety guarantees of coroutines. Both <code translate="no" dir="ltr">Room</code> and <code translate="no" dir="ltr">Retrofit</code> will give us main-safety, and we don&#39;t need to do anything else to make network requests or database queries with Flow.</p>
<p>This flow uses the following threads already:</p>
<ul>
<li><code translate="no" dir="ltr">plantService.customPlantSortOrder</code> runs on a Retrofit thread  (it calls  <a href="https://square.github.io/retrofit/2.x/retrofit/retrofit2/Call.html#enqueue-retrofit2.Callback-" target="_blank"><code translate="no" dir="ltr">Call.enqueue</code></a>)</li>
<li><code translate="no" dir="ltr">getPlantsFlow</code> will run queries on a Room  <a href="https://developer.android.com/reference/androidx/room/RoomDatabase.Builder.html#setQueryExecutor(java.util.concurrent.Executor)" target="_blank">Executor</a></li>
<li><code translate="no" dir="ltr">applySort</code> will run on the collecting dispatcher (in this case <code translate="no" dir="ltr">Dispatchers.Main</code>)</li>
</ul>
<p>So if all we were doing was calling suspend functions in <code translate="no" dir="ltr">Retrofit</code> and using <code translate="no" dir="ltr">Room</code> flows, we wouldn&#39;t need to complicate this code with main-safety concerns.</p>
<p>However, as our data set grows in size, the call to <code translate="no" dir="ltr">applySort</code> may become slow enough to block the main thread. <code translate="no" dir="ltr">Flow</code> offers a declarative API called <code translate="no" dir="ltr">flowOn</code> to control which thread the flow runs on.</p>
<p>Add <code translate="no" dir="ltr">flowOn</code> to the <code translate="no" dir="ltr">plantsFlow</code> like this:</p>
<h3 is-upgraded id="plantrepository.kt_9" data-text="PlantRepository.kt" tabindex="-1"><strong>PlantRepository.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">private</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">customSortFlow</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantsListSortOrderCache</span><span class="devsite-syntax-o">::</span><span class="devsite-syntax-n">getOrAwait</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">asFlow</span><span class="devsite-syntax-p">()</span>

<span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plantsFlow</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">Flow&lt;List&lt;Plant&gt;</span>&gt;
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-k">get</span><span class="devsite-syntax-p">()</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlantsFlow</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">combine</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">customSortFlow</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plants</span><span class="devsite-syntax-p">,</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">sortOrder</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">          </span><span class="devsite-syntax-n">plants</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">applySort</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">sortOrder</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">flowOn</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">defaultDispatcher</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">conflate</span><span class="devsite-syntax-p">()</span>
</code></pre></devsite-code>
<p>Calling <code translate="no" dir="ltr">flowOn</code> has two important effects on how the code executes:</p>
<ol type="1">
<li>Launch a new coroutine on the <code translate="no" dir="ltr">defaultDispatcher</code> (in this case, <code translate="no" dir="ltr">Dispatchers.Default</code>) to run and collect the flow <strong>before</strong> the call to <code translate="no" dir="ltr">flowOn</code>.</li>
<li>Introduces a buffer to send results from the new coroutine to later calls.</li>
<li>Emit the values from that buffer into the <code translate="no" dir="ltr">Flow</code> <strong>after </strong><code translate="no" dir="ltr">flowOn</code>. In this case, that&#39;s <code translate="no" dir="ltr">asLiveData</code> in the <code translate="no" dir="ltr">ViewModel</code>.</li>
</ol>
<p>This is very similar to how <code translate="no" dir="ltr">withContext</code> works to switch dispatchers, but it does introduce a buffer in the middle of our transforms that changes how the flow works. The coroutine launched by <code translate="no" dir="ltr">flowOn</code> is allowed to produce results <em>faster</em> than the caller consumes them, and it will buffer a large number of them by default.</p>
<p>In this case, we plan on sending the results to the UI, so we would only ever care about the most recent result. That&#39;s what the <code translate="no" dir="ltr">conflate</code> operator does–it modifies the buffer of <code translate="no" dir="ltr">flowOn</code> to store only the last result. If another result comes in before the previous one is read, it gets overwritten.</p>
<aside class="special"><p>The operator <code translate="no" dir="ltr">flowOn</code> launches a new coroutine to collect the flow above it and introduces a buffer to write the results.</p>
<p>You can control the buffer with more operators, such as <code translate="no" dir="ltr">conflate</code> which says to store only the last value produced in the buffer.</p>
</aside>
<aside class="warning"><p>It&#39;s important to be aware of the buffer when using <code translate="no" dir="ltr">flowOn</code> with large objects such as Room results since it is easy to use a large amount of memory buffering results.</p>
</aside>
<h2 is-upgraded id="run-the-app" data-text="Run the app" tabindex="-1"><strong>Run the app</strong></h2>
<p>If you run the app again, you should see that you&#39;re now loading the data and applying the custom sort order using <code translate="no" dir="ltr">Flow</code>! Since we haven&#39;t implemented the <code translate="no" dir="ltr">switchMap</code> yet, the filter option doesn&#39;t do anything.</p>
<p>In the next step we&#39;ll take a look at another way to provide main safety using <code translate="no" dir="ltr">flow</code>.</p>


        </google-codelab-step>
      
        <google-codelab-step label="Switching between two flows" duration="5" step="11">
          
          <h2 class="step-title" id="11" data-text="Switching between two flows" tabindex="-1">
              12. Switching between two flows
          </h2>
          <p>To finish up the flow version of this API, open up <code translate="no" dir="ltr">PlantListViewModel.kt</code>, where we will switch between the flows based on <code translate="no" dir="ltr">GrowZone</code> like we do in the <code translate="no" dir="ltr">LiveData</code> version.</p>
<p>Add the following code below the <code translate="no" dir="ltr">plants</code> <code translate="no" dir="ltr">liveData</code>:</p>
<h3 is-upgraded id="plantlistviewmodel.kt_3" data-text="PlantListViewModel.kt" tabindex="-1"><strong>PlantListViewModel.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">private</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">growZoneFlow</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">MutableStateFlow&lt;GrowZone&gt;</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">NoGrowZone</span><span class="devsite-syntax-p">)</span>

<span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plantsUsingFlow</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">LiveData&lt;List&lt;Plant&gt;</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">growZoneFlow</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">flatMapLatest</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-k">if</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">==</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">NoGrowZone</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">            </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">plantsFlow</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-p">}</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-k">else</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">            </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlantsWithGrowZoneFlow</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">}.</span><span class="devsite-syntax-na">asLiveData</span><span class="devsite-syntax-p">()</span>
</code></pre></devsite-code>
<aside class="warning"><p>Note, this example uses several <code translate="no" dir="ltr">@ExperimentalCoroutinesApis</code>, and it is likely that there will be a more concise version in the final version of the Flow APIs.</p>
</aside>
<p>This pattern shows how to integrate events (grow zone changing) into a flow. It does exactly the same thing as the <code translate="no" dir="ltr">LiveData.switchMap</code> version–switching between two data sources based on an event.</p>
<h2 is-upgraded id="stepping-through-the-code" data-text="Stepping through the code" tabindex="-1"><strong>Stepping through the code</strong></h2>
<h3 is-upgraded id="plantlistviewmodel.kt_4" data-text="PlantListViewModel.kt" tabindex="-1">PlantListViewModel.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">private</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">growZoneFlow</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">MutableStateFlow&lt;GrowZone&gt;</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">NoGrowZone</span><span class="devsite-syntax-p">)</span>
</code></pre></devsite-code>
<p>This defines a new  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-state-flow/" target="_blank"><code translate="no" dir="ltr">MutableStateFlow</code></a> with an initial value of <code translate="no" dir="ltr">NoGrowZone</code>. This is a special kind of Flow value holder that holds only the last value it was given. It&#39;s a thread-safe concurrency primitive, so you can write to it from multiple threads at the same time (and whichever is considered &#34;last&#34; will win).</p>
<p>You can also subscribe to get updates to the current value. Overall, it has similar behavior to a <code translate="no" dir="ltr">LiveData</code>–it just holds the last value and lets you observe changes to it.</p>
<aside class="special"><p><code translate="no" dir="ltr">StateFlow</code> is different from a regular flow created using, for example, the <code translate="no" dir="ltr">flow{}</code> builder. A <code translate="no" dir="ltr">StateFlow</code> is created with an initial value and keeps its state even without being collected and between subsequent collections. You can use the <code translate="no" dir="ltr">MutableStateFlow</code> interface (as shown above) to change the value (state) of a <code translate="no" dir="ltr">StateFlow</code>.</p>
<p>You will often find that flows that behave like StateFlow are called <em>hot</em>, as opposed to regular, <em>cold</em> flows which only execute when they&#39;re collected.</p>
</aside>
<h3 is-upgraded id="plantlistviewmodel.kt_5" data-text="PlantListViewModel.kt" tabindex="-1">PlantListViewModel.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">plantsUsingFlow</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">LiveData&lt;List&lt;Plant&gt;</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">growZoneFlow</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">flatMapLatest</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
</code></pre></devsite-code>
<p><code translate="no" dir="ltr">StateFlow</code> is also a regular <code translate="no" dir="ltr">Flow</code>, so you can use all the operators as you normally would.</p>
<p>Here we use the <code translate="no" dir="ltr">flatMapLatest</code> operator which is exactly the same as <code translate="no" dir="ltr">switchMap</code> from <code translate="no" dir="ltr">LiveData</code>. Whenever the <code translate="no" dir="ltr">growZone</code> changes its value, this lambda will be applied and it must return a <code translate="no" dir="ltr">Flow</code>. Then, the returned <code translate="no" dir="ltr">Flow</code> will be used as the <code translate="no" dir="ltr">Flow</code> for all downstream operators.</p>
<p>Basically, this lets us switch between different flows based on the value of <code translate="no" dir="ltr">growZone</code>.</p>
<aside class="special"><p>Flow&#39;s <code translate="no" dir="ltr">flatMapLatest</code> extensions allow you to switch between multiple flows.</p>
</aside>
<h3 is-upgraded id="plantlistviewmodel.kt_6" data-text="PlantListViewModel.kt" tabindex="-1">PlantListViewModel.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-k">if</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">==</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">NoGrowZone</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">plantsFlow</span>
<span class="devsite-syntax-p">}</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-k">else</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlantsWithGrowZoneFlow</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>Inside the <code translate="no" dir="ltr">flatMapLatest</code>, we switch based on the <code translate="no" dir="ltr">growZone</code>. This code is pretty much the same as the <code translate="no" dir="ltr">LiveData.switchMap</code> version, with the only difference being that it returns <code translate="no" dir="ltr">Flows</code> instead of <code translate="no" dir="ltr">LiveDatas</code>.</p>
<h3 is-upgraded id="plantlistviewmodel.kt_7" data-text="PlantListViewModel.kt" tabindex="-1">PlantListViewModel.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-w">   </span><span class="devsite-syntax-p">}.</span><span class="devsite-syntax-na">asLiveData</span><span class="devsite-syntax-p">()</span>
</code></pre></devsite-code>
<p>And finally, we convert the <code translate="no" dir="ltr">Flow</code> into a <code translate="no" dir="ltr">LiveData</code>, since our <code translate="no" dir="ltr">Fragment</code> expects us to expose a <code translate="no" dir="ltr">LiveData</code> from the <code translate="no" dir="ltr">ViewModel</code>.</p>
<aside class="special"><p>The  <a href="https://developer.android.com/reference/kotlin/androidx/lifecycle/package-summary#aslivedata" target="_blank"><code translate="no" dir="ltr">asLiveData</code></a> operator will convert a <code translate="no" dir="ltr">Flow</code> into a <code translate="no" dir="ltr">LiveData</code> with a configurable timeout.</p>
<p>Just like the <code translate="no" dir="ltr">liveData</code> builder, the timeout will keep the flow active through rotations so your collection doesn&#39;t restart.</p>
</aside>
<h2 is-upgraded id="change-a-value-of-stateflow" data-text="Change a value of StateFlow" tabindex="-1"><strong>Change a value of StateFlow</strong></h2>
<p>To let the app know about the filter change, we can set <code translate="no" dir="ltr">MutableStateFlow.value</code>. It&#39;s an easy way to communicate an event into a coroutine like we&#39;re doing here.</p>
<h3 is-upgraded id="plantlistviewmodel.kt_8" data-text="PlantListViewModel.kt" tabindex="-1"><strong>PlantListViewModel.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">setGrowZoneNumber</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">num</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kt">Int</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">GrowZone</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">num</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">growZoneFlow</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">GrowZone</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">num</span><span class="devsite-syntax-p">)</span>

<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">launchDataLoad</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">tryUpdateRecentPlantsForGrowZoneCache</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">GrowZone</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">num</span><span class="devsite-syntax-p">))</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">}</span>

<span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">clearGrowZoneNumber</span><span class="devsite-syntax-p">()</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">NoGrowZone</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">growZoneFlow</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">NoGrowZone</span>

<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">launchDataLoad</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">tryUpdateRecentPlantsCache</span><span class="devsite-syntax-p">()</span><span class="devsite-syntax-w"> </span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<h2 is-upgraded id="run-the-app-again" data-text="Run the app again" tabindex="-1"><strong>Run the app again</strong></h2>
<p>If you run the app again, the filter now works for both the <code translate="no" dir="ltr">LiveData</code> version and the <code translate="no" dir="ltr">Flow</code> version!</p>
<p>In the next step, we&#39;ll apply the custom sort to <code translate="no" dir="ltr">getPlantsWithGrowZoneFlow</code>.</p>


        </google-codelab-step>
      
        <google-codelab-step label="Mixing styles with flow" duration="6" step="12">
          
          <h2 class="step-title" id="12" data-text="Mixing styles with flow" tabindex="-1">
              13. Mixing styles with flow
          </h2>
          <p>One of the most exciting features of <code translate="no" dir="ltr">Flow</code> is its first-class support for suspend functions. The <code translate="no" dir="ltr">flow</code> builder and almost every transform exposes a <code translate="no" dir="ltr">suspend</code> operator that can call any suspending functions. As a result, <strong>main-safety</strong> for network and database calls as well as orchestrating multiple async operations can be done using calls to regular suspend functions from inside a flow.</p>
<p>In effect, this allows you to naturally mix declarative transforms with imperative code. As you&#39;ll see in this example, inside of a regular map operator you can orchestrate multiple async operations without applying any extra transformations. In a lot of places, this can lead to substantially simpler code than that of a fully-declarative approach.</p>
<aside class="special"><p>If you&#39;ve used libraries like RxJava extensively, this is one of the main differences provided by <code translate="no" dir="ltr">Flow</code>.</p>
<p>As you get started with <code translate="no" dir="ltr">Flow</code>, carefully consider how you can use suspending transforms to simplify your code. In many cases, you can express async code naturally by leaning on suspending operations inside operators like <code translate="no" dir="ltr">map</code>, <code translate="no" dir="ltr">onStart</code>, and <code translate="no" dir="ltr">onCompletion</code>.</p>
<p>Familiar operators from Rx like <code translate="no" dir="ltr">combine</code>, <code translate="no" dir="ltr">mapLatest</code>, <code translate="no" dir="ltr">flatMapLatest</code>, <code translate="no" dir="ltr">flattenMerge</code>, and <code translate="no" dir="ltr">flatMapMerge</code> are best used to orchestrate concurrency in <code translate="no" dir="ltr">Flow</code>.</p>
</aside>
<h2 is-upgraded id="using-suspend-functions-to-orchestrate-async-work" data-text="Using suspend functions to orchestrate async work" tabindex="-1"><strong>Using suspend functions to orchestrate async work</strong></h2>
<p>To wrap up our exploration of <code translate="no" dir="ltr">Flow</code>, we&#39;ll apply the custom sort using suspend operators.</p>
<p>Open up <code translate="no" dir="ltr">PlantRepository.kt</code> and add a map transform to <code translate="no" dir="ltr">getPlantsWithGrowZoneNumberFlow</code>.</p>
<h3 is-upgraded id="plantrepository.kt_10" data-text="PlantRepository.kt" tabindex="-1">PlantRepository.kt</h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">getPlantsWithGrowZoneFlow</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">GrowZone</span><span class="devsite-syntax-p">):</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">Flow&lt;List&lt;Plant&gt;</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-k">return</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantDao</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getPlantsWithGrowZoneNumberFlow</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">number</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">map</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantList</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">           </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">sortOrderFromNetwork</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantsListSortOrderCache</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">getOrAwait</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">           </span><span class="devsite-syntax-kd">val</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nv">nextValue</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">plantList</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">applyMainSafeSort</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">sortOrderFromNetwork</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">           </span><span class="devsite-syntax-n">nextValue</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>By relying on regular suspend functions to handle the async work, this map operation is <strong>main-safe</strong> even though it combines two async operations.</p>
<p>As each result from the database is returned, we&#39;ll get the cached sort order–and if it&#39;s not ready yet, it will wait on the async network request. Then once we have the sort order, it&#39;s safe to call <code translate="no" dir="ltr">applyMainSafeSort</code>, which will run the sort on the default dispatcher.</p>
<p>This code is now entirely main-safe by deferring the main safety concerns to regular suspend functions. It&#39;s quite a bit simpler than the same transformation implemented in <code translate="no" dir="ltr">plantsFlow</code>.</p>
<aside class="special"><p>In <code translate="no" dir="ltr">Flow</code>, <code translate="no" dir="ltr">map</code> and other operators accept a suspending lambda.</p>
<p>By using the suspend and resume mechanism of coroutines, you can often orchestrate sequential async calls easily without using declarative transforms.</p>
</aside>
<aside class="warning"><p>It is an <strong>error</strong> to emit a value from a different coroutine than the one that called the suspending transformation.</p>
<p>If you do launch another coroutine inside a flow operation like we&#39;re doing here inside <code translate="no" dir="ltr">getOrAwait</code> and <code translate="no" dir="ltr">applyMainSafeSort</code>, make sure the value is returned to the original coroutine before <code translate="no" dir="ltr">emitting</code> it.</p>
</aside>
<p>However, it is worth noting that it will execute a bit differently. The cached value will be fetched every single time the database emits a new value. This is OK because we&#39;re caching it correctly in <code translate="no" dir="ltr">plantsListSortOrderCache</code>, but if that started a new network request this implementation would make a lot of unnecessary network requests. In addition, in the <code translate="no" dir="ltr">.combine</code> version, the network request and the database query run <em>concurrently</em>, while in this version they run in sequence.</p>
<p>Due to these differences, there is not a clear rule to structure this code. In many cases, it&#39;s fine to use suspending transformations like we&#39;re doing here, which makes all async operations sequential. However, in other cases, it&#39;s better to use operators to control concurrency and provide main-safety.</p>


        </google-codelab-step>
      
        <google-codelab-step label="Controlling concurrency with flow" duration="6" step="13">
          
          <h2 class="step-title" id="13" data-text="Controlling concurrency with flow" tabindex="-1">
              14. Controlling concurrency with flow
          </h2>
          <p>You&#39;re almost there! As one final (optional) step, let&#39;s move the network requests into a flow-based coroutine.</p>
<p>By doing so, we&#39;ll remove the logic for making the network calls from the handlers called by <code translate="no" dir="ltr">onClick</code> and drive them from the <code translate="no" dir="ltr">growZone</code>. This helps us create a single source of truth and avoid code duplication–there&#39;s no way any code can change the filter without refreshing the cache.</p>
<p>Open up <code translate="no" dir="ltr">PlantListViewModel.kt</code>, and add this to the init block:</p>
<h3 is-upgraded id="plantlistviewmodel.kt_9" data-text="PlantListViewModel.kt" tabindex="-1"><strong>PlantListViewModel.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-k">init</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">clearGrowZoneNumber</span><span class="devsite-syntax-p">()</span>

<span class="devsite-syntax-w">   </span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">mapLatest</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">           </span><span class="devsite-syntax-n">_spinner</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kc">true</span>
<span class="devsite-syntax-w">           </span><span class="devsite-syntax-k">if</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">==</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">NoGrowZone</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">               </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">tryUpdateRecentPlantsCache</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">           </span><span class="devsite-syntax-p">}</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-k">else</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">               </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">tryUpdateRecentPlantsForGrowZoneCache</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">           </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">onEach</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w">  </span><span class="devsite-syntax-n">_spinner</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kc">false</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">catch</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">throwable</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;<span class="devsite-syntax-w">  </span><span class="devsite-syntax-n">_snackbar</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">throwable</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">message</span><span class="devsite-syntax-w">  </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-w">       </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">launchIn</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">viewModelScope</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>This code will launch a new coroutine to observe the values sent to <code translate="no" dir="ltr">growZoneChannel</code>. You can comment out the network calls in the methods below now as they&#39;re only needed for the <code translate="no" dir="ltr">LiveData</code> version.</p>
<h3 is-upgraded id="plantlistviewmodel.kt_10" data-text="PlantListViewModel.kt" tabindex="-1"><strong>PlantListViewModel.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">setGrowZoneNumber</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">num</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kt">Int</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">GrowZone</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">num</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">growZoneFlow</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">GrowZone</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">num</span><span class="devsite-syntax-p">)</span>

<span class="devsite-syntax-w">    </span><span class="devsite-syntax-c1">// launchDataLoad { </span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-c1">//    plantRepository.tryUpdateRecentPlantsForGrowZoneCache(GrowZone(num))</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-c1">// }</span>
<span class="devsite-syntax-p">}</span>

<span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-nf">clearGrowZoneNumber</span><span class="devsite-syntax-p">()</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">NoGrowZone</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">growZoneFlow</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">NoGrowZone</span>

<span class="devsite-syntax-w">    </span><span class="devsite-syntax-c1">// launchDataLoad {</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-c1">//    plantRepository.tryUpdateRecentPlantsCache()</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-c1">// }</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<h2 is-upgraded id="run-the-app-again_1" data-text="Run the app again" tabindex="-1"><strong>Run the app again</strong></h2>
<p>If you run the app again now, you&#39;ll see that the network refresh is now controlled by the <code translate="no" dir="ltr">growZone</code>! We&#39;ve improved the code substantially, as more ways to change the filter come in the channel acts as a single source of truth for which filter is active. That way the network request and the current filter can never get out of sync.</p>
<h2 is-upgraded id="stepping-through-the-code_1" data-text="Stepping through the code" tabindex="-1"><strong>Stepping through the code</strong></h2>
<p>Let&#39;s step through all the new functions used one at a time, starting from the outside:</p>
<h3 is-upgraded id="plantlistviewmodel.kt_11" data-text="PlantListViewModel.kt" tabindex="-1"><strong>PlantListViewModel.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-n">growZone</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-c1">// ...</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">launchIn</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">viewModelScope</span><span class="devsite-syntax-p">)</span>
</code></pre></devsite-code>
<p>This time, we use the  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/launch-in.html" target="_blank"><code translate="no" dir="ltr">launchIn</code></a> operator to collect the flow inside our <code translate="no" dir="ltr">ViewModel</code>.</p>
<p>The operator <code translate="no" dir="ltr">launchIn</code> creates a new coroutine and collects every value from the flow. It&#39;ll launch in the <code translate="no" dir="ltr">CoroutineScope</code> provided–in this case, the <code translate="no" dir="ltr">viewModelScope</code>. This is great because it means when this <code translate="no" dir="ltr">ViewModel</code> gets cleared, the collection will be cancelled.</p>
<p>Without providing any other operators, this doesn&#39;t do very much–but since <code translate="no" dir="ltr">Flow</code> provides suspending lambdas in all of its operators it&#39;s easy to make async actions based on every value.</p>
<aside class="special"><p>Using <code translate="no" dir="ltr">Flow</code>, it&#39;s natural to collect data in the <code translate="no" dir="ltr">ViewModel</code>, <code translate="no" dir="ltr">Repository</code>, or other data layers when needed.</p>
<p>Since <code translate="no" dir="ltr">Flow</code> is not tied to the UI, you don&#39;t need a UI observer to <code translate="no" dir="ltr">collect</code> a flow. This is a big difference from <code translate="no" dir="ltr">LiveData</code> which always requires a UI-observer to run. It is not a good idea to try to <code translate="no" dir="ltr">observe</code> a <code translate="no" dir="ltr">LiveData</code> in your <code translate="no" dir="ltr">ViewModel</code> because it doesn&#39;t have an appropriate observation lifecycle.</p>
</aside>
<h3 is-upgraded id="plantlistviewmodel.kt_12" data-text="PlantListViewModel.kt" tabindex="-1"><strong>PlantListViewModel.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">mapLatest</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-n">_spinner</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kc">true</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-k">if</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">==</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">NoGrowZone</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">tryUpdateRecentPlantsCache</span><span class="devsite-syntax-p">()</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">}</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-k">else</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
<span class="devsite-syntax-w">        </span><span class="devsite-syntax-n">plantRepository</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">tryUpdateRecentPlantsForGrowZoneCache</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">growZone</span><span class="devsite-syntax-p">)</span>
<span class="devsite-syntax-w">    </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p>This is where the magic lies–<code translate="no" dir="ltr">mapLatest</code> will apply this map function for each value. However, unlike regular <code translate="no" dir="ltr">map</code>, it&#39;ll launch a new coroutine for each call to the map transform. Then, if a new value is emitted by the <code translate="no" dir="ltr">growZoneChannel</code> before the previous coroutine completes, it&#39;ll cancel it before starting a new one.</p>
<p>We can use <code translate="no" dir="ltr">mapLatest</code> to control concurrency for us. Instead of building cancel/restart logic ourselves, the flow transform can take care of it. This code saves a lot of code and complexity compared to writing the same cancellation logic by hand.</p>
<p>Cancellation of a <code translate="no" dir="ltr">Flow</code> follows the normal  <a href="https://kotlinlang.org/docs/reference/coroutines/cancellation-and-timeouts.html#cancellation-is-cooperative" target="_blank">cooperative cancellation rules</a> of coroutines.</p>
<aside class="special"><p>If you&#39;ve used RxJava, you can use <code translate="no" dir="ltr">mapLatest</code> exactly like you&#39;d use <code translate="no" dir="ltr">switchMap</code>.</p>
<p>The key difference is that it provides a suspending lambda for you in a new coroutine, so you can call regular suspend functions directly from <code translate="no" dir="ltr">mapLatest</code>.</p>
</aside>
<h3 is-upgraded id="plantlistviewmodel.kt_13" data-text="PlantListViewModel.kt" tabindex="-1"><strong>PlantListViewModel.kt</strong></h3>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">onEach</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w">  </span><span class="devsite-syntax-n">_spinner</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-kc">false</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">}</span>
<span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">catch</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">throwable</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">_snackbar</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">value</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">=</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">throwable</span><span class="devsite-syntax-p">.</span><span class="devsite-syntax-na">message</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">}</span>
</code></pre></devsite-code>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/on-each.html" target="_blank"><code translate="no" dir="ltr">onEach</code></a> will be called every time the flow above it emits a value. Here we&#39;re using it to reset the spinner after processing is complete.</p>
<p>The  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/catch.html" target="_blank"><code translate="no" dir="ltr">catch</code></a> operator will capture any exceptions thrown above it in the flow. It can emit a new value to the flow like an error state, rethrow the exception back into the flow, or perform work like we&#39;re doing here.</p>
<p>When there&#39;s an error we&#39;re just telling our <code translate="no" dir="ltr">_snackbar</code> to display the error message.</p>
<h2 is-upgraded id="wrapping-up" data-text="Wrapping up" tabindex="-1"><strong>Wrapping up</strong></h2>
<p>This step showed you how you can control concurrency using <code translate="no" dir="ltr">Flow</code>, as well as consume <code translate="no" dir="ltr">Flows</code> inside a <code translate="no" dir="ltr">ViewModel</code> without depending on a UI observer.</p>
<p>As a challenge step, try to define a function to encapsulate the data loading of this flow with the following signature:</p>
<div></div><devsite-code><pre class="devsite-click-to-copy" translate="no" dir="ltr" is-upgraded syntax="Kotlin"><code translate="no" dir="ltr"><span class="devsite-syntax-kd">fun</span><span class="devsite-syntax-w"> </span>&lt;<span class="devsite-syntax-nf">T</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">loadDataFor</span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">source</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">StateFlow&lt;T&gt;</span><span class="devsite-syntax-p">,</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">block</span><span class="devsite-syntax-p">:</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-n">suspend</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">(</span><span class="devsite-syntax-n">T</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-o">-</span>&gt;<span class="devsite-syntax-w"> </span><span class="devsite-syntax-kt">Unit</span><span class="devsite-syntax-p">)</span><span class="devsite-syntax-w"> </span><span class="devsite-syntax-p">{</span>
</code></pre></devsite-code>


        </google-codelab-step>
      
    </google-codelab>
  
  

  
</div>

  
    
    
    
  

  <div class="devsite-floating-action-buttons"></div></article>


<devsite-content-footer class="nocontent">
  <p>Except as otherwise noted, the content of this page is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 License</a>, and code samples are licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a>. For details, see the <a href="https://developers.google.com/site-policies">Google Developers Site Policies</a>. Java is a registered trademark of Oracle and/or its affiliates.</p>
  
</devsite-content-footer>


<devsite-notification
>
</devsite-notification>


  
<div class="devsite-content-data">
  
  
    <template class="devsite-content-data-template">
      [[["Easy to understand","easyToUnderstand","thumb-up"],["Solved my problem","solvedMyProblem","thumb-up"],["Other","otherUp","thumb-up"]],[["Missing the information I need","missingTheInformationINeed","thumb-down"],["Too complicated / too many steps","tooComplicatedTooManySteps","thumb-down"],["Out of date","outOfDate","thumb-down"],["Samples / code issue","samplesCodeIssue","thumb-down"],["Other","otherDown","thumb-down"]],[],[],[],null,[]]
    </template>
  
</div>
            
          </devsite-content>
        </main>
        <devsite-footer-promos class="devsite-footer">
          
            

<nav class="devsite-footer-promos nocontent" aria-label="Promotions">
  <ul class="devsite-footer-promos-list">
    
    <li class="devsite-footer-promo">
      <a href="//x.com/AndroidDev"
         class="devsite-footer-promo-title gc-analytics-event"
         data-category="Site-Wide Custom Events"
       
       
         data-label="Footer X Promo"
       >
        
        
        <picture>
          
          <source class="devsite-dark-theme"
                  srcset="https://developer.android.com/_static/android/images/logo-x_dt.svg"
                  media="(prefers-color-scheme: dark)">
          
          <img class="devsite-footer-promo-icon"
                src="/_static/android/images/logo-x.svg"
                loading="lazy"
                alt="X">
        </picture>
        
        <span class="devsite-footer-promo-label">
          X
        </span>
      </a>
      <div class="devsite-footer-promo-description">Follow @AndroidDev on X</div>
    </li>
    
    <li class="devsite-footer-promo">
      <a href="//www.youtube.com/user/androiddevelopers"
         class="devsite-footer-promo-title gc-analytics-event"
         data-category="Site-Wide Custom Events"
       
       
         data-label="Footer YouTube Promo"
       >
        
        
        <picture>
          
          <source class="devsite-dark-theme"
                  srcset="https://developer.android.com/_static/android/images/logo-youtube_dt.svg"
                  media="(prefers-color-scheme: dark)">
          
          <img class="devsite-footer-promo-icon"
                src="//www.gstatic.com/images/icons/material/product/2x/youtube_48dp.png"
                loading="lazy"
                alt="YouTube">
        </picture>
        
        <span class="devsite-footer-promo-label">
          YouTube
        </span>
      </a>
      <div class="devsite-footer-promo-description">Check out Android Developers on YouTube</div>
    </li>
    
    <li class="devsite-footer-promo">
      <a href="//www.linkedin.com/showcase/androiddev"
         class="devsite-footer-promo-title gc-analytics-event"
         data-category="Site-Wide Custom Events"
       
       
         data-label="Footer LinkedIn Promo"
       >
        
        
        <picture>
          
          <source class="devsite-dark-theme"
                  srcset="https://developer.android.com/_static/android/images/logo-linkedin_dt.svg"
                  media="(prefers-color-scheme: dark)">
          
          <img class="devsite-footer-promo-icon"
                src="/_static/android/images/logo-linkedin.svg"
                loading="lazy"
                alt="LinkedIn">
        </picture>
        
        <span class="devsite-footer-promo-label">
          LinkedIn
        </span>
      </a>
      <div class="devsite-footer-promo-description">Connect with the Android Developers community on LinkedIn</div>
    </li>
    
  </ul>
</nav>

          
        </devsite-footer-promos>
        <devsite-footer-linkboxes class="devsite-footer">
          
            
<nav class="devsite-footer-linkboxes nocontent" aria-label="Footer links">
  
  <ul class="devsite-footer-linkboxes-list">
    
    <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading no-link">More Android</h3>
      <ul class="devsite-footer-linkbox-list">
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="//www.android.com"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 1)"
            >
            
          
            Android
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="//www.android.com/enterprise/"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 2)"
            >
            
          
            Android for Enterprise
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="//www.android.com/security-center/"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 3)"
            >
            
          
            Security
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="//source.android.com"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 4)"
            >
            
          
            Source
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/news"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 5)"
            >
            
          
            News
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="//android-developers.googleblog.com/"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 6)"
            >
            
          
            Blog
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/podcasts"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 7)"
            >
            
              
              
            
          
            Podcasts
          
          </a>
          
          
        </li>
        
      </ul>
    </li>
    
    <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading no-link">Discover</h3>
      <ul class="devsite-footer-linkbox-list">
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/games"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 1)"
            >
            
          
            Gaming
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/ml"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 2)"
            >
            
          
            Machine Learning
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/health-and-fitness"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 3)"
            >
            
          
            Health & Fitness
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/media"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 4)"
            >
            
          
            Camera & Media
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/privacy"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 5)"
            >
            
          
            Privacy
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/training/connectivity/5g"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 6)"
            >
            
              
              
            
          
            5G
          
          </a>
          
          
        </li>
        
      </ul>
    </li>
    
    <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading no-link">Android Devices</h3>
      <ul class="devsite-footer-linkbox-list">
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/large-screens"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 1)"
            >
            
          
            Large screens
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/wear"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 2)"
            >
            
          
            Wear OS
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/chrome-os"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 3)"
            >
            
          
            ChromeOS devices
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/cars"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 4)"
            >
            
          
            Android for cars
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/tv"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 5)"
            >
            
              
              
            
          
            Android TV
          
          </a>
          
          
        </li>
        
      </ul>
    </li>
    
    <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading no-link">Releases</h3>
      <ul class="devsite-footer-linkbox-list">
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/about/versions/15"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 1)"
            >
            
          
            Android 15
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/about/versions/14"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 2)"
            >
            
          
            Android 14
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/about/versions/13"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 3)"
            >
            
          
            Android 13
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/about/versions/12"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 4)"
            >
            
          
            Android 12
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/about/versions/11"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 5)"
            >
            
          
            Android 11
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/about/versions/10"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 6)"
            >
            
          
            Android 10
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/about/versions/pie"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 7)"
            >
            
              
              
            
          
            Pie
          
          </a>
          
          
        </li>
        
      </ul>
    </li>
    
    <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading no-link">Documentation and Downloads</h3>
      <ul class="devsite-footer-linkbox-list">
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/studio/intro"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 1)"
            >
            
          
            Android Studio guide
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/guide"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 2)"
            >
            
          
            Developers guides
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/reference"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 3)"
            >
            
          
            API reference
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/studio"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 4)"
            >
            
          
            Download Studio
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="/ndk"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 5)"
            >
            
              
              
            
          
            Android NDK
          
          </a>
          
          
        </li>
        
      </ul>
    </li>
    
    <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading no-link">Support</h3>
      <ul class="devsite-footer-linkbox-list">
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="//issuetracker.google.com/issues/new?component=190923&amp;template=841312"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 1)"
            >
            
          
            Report platform bug
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="//issuetracker.google.com/issues/new?component=192697"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 2)"
            >
            
          
            Report documentation bug
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="//support.google.com/googleplay/android-developer"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 3)"
            >
            
          
            Google Play support
          
          </a>
          
          
        </li>
        
        <li class="devsite-footer-linkbox-item">
          
          <a href="https://g.co/userresearch/androiddeveloperfooter"
             class="devsite-footer-linkbox-link gc-analytics-event"
             data-category="Site-Wide Custom Events"
            
             data-label="Footer Link (index 4)"
            >
            
              
              
            
          
            Join research studies
          
          </a>
          
          
        </li>
        
      </ul>
    </li>
    
  </ul>
  
</nav>
          
        </devsite-footer-linkboxes>
        <devsite-footer-utility class="devsite-footer">
          
            

<div class="devsite-footer-utility nocontent">
  
  
  <nav class="devsite-footer-sites" aria-label="Other Google Developers websites">
    <a href="https://developers.google.com/"
       class="devsite-footer-sites-logo-link gc-analytics-event"
       data-category="Site-Wide Custom Events"
       data-label="Footer Google Developers Link">
      <picture>
        
        <source srcset="https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/images/lockup-google-for-developers-dark-theme.svg"
                media="(prefers-color-scheme: none)"
                class="devsite-dark-theme">
        
        <img class="devsite-footer-sites-logo"
             src="https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/images/lockup-google-for-developers.svg"
             loading="lazy"
             alt="Google Developers">
      </picture>
    </a>
    <ul class="devsite-footer-sites-list">
      
      <li class="devsite-footer-sites-item">
        <a href="//developer.android.com"
           class="devsite-footer-sites-link
                  gc-analytics-event"
           data-category="Site-Wide Custom Events"
         
           data-label="Footer Android Link"
         
         >
          Android
        </a>
      </li>
      
      <li class="devsite-footer-sites-item">
        <a href="//developer.chrome.com/home"
           class="devsite-footer-sites-link
                  gc-analytics-event"
           data-category="Site-Wide Custom Events"
         
           data-label="Footer Chrome Link"
         
         >
          Chrome
        </a>
      </li>
      
      <li class="devsite-footer-sites-item">
        <a href="//firebase.google.com"
           class="devsite-footer-sites-link
                  gc-analytics-event"
           data-category="Site-Wide Custom Events"
         
           data-label="Footer Firebase Link"
         
         >
          Firebase
        </a>
      </li>
      
      <li class="devsite-footer-sites-item">
        <a href="//cloud.google.com"
           class="devsite-footer-sites-link
                  gc-analytics-event"
           data-category="Site-Wide Custom Events"
         
           data-label="Footer Google Cloud Platform Link"
         
         >
          Google Cloud Platform
        </a>
      </li>
      
      <li class="devsite-footer-sites-item">
        <a href="//developers.google.com/products/"
           class="devsite-footer-sites-link
                  gc-analytics-event"
           data-category="Site-Wide Custom Events"
         
           data-label="Footer All products Link"
         
         >
          All products
        </a>
      </li>
      
    </ul>
  </nav>
  

  
  <nav class="devsite-footer-utility-links" aria-label="Utility links">
    
    <ul class="devsite-footer-utility-list">
      
      <li class="devsite-footer-utility-item
                 ">
        
        
        <a class="devsite-footer-utility-link gc-analytics-event"
           href="//policies.google.com/privacy"
           data-category="Site-Wide Custom Events"
           data-label="Footer Privacy link"
         >
          Privacy
        </a>
        
      </li>
      
      <li class="devsite-footer-utility-item
                 ">
        
        
        <a class="devsite-footer-utility-link gc-analytics-event"
           href="/license"
           data-category="Site-Wide Custom Events"
           data-label="Footer License link"
         >
          License
        </a>
        
      </li>
      
      <li class="devsite-footer-utility-item
                 ">
        
        
        <a class="devsite-footer-utility-link gc-analytics-event"
           href="/distribute/marketing-tools/brand-guidelines"
           data-category="Site-Wide Custom Events"
           data-label="Footer Brand guidelines link"
         >
          Brand guidelines
        </a>
        
      </li>
      
      <li class="devsite-footer-utility-item
                 glue-cookie-notification-bar-control">
        
        
        <a class="devsite-footer-utility-link gc-analytics-event"
           href="#"
           data-category="Site-Wide Custom Events"
           data-label="Footer Manage cookies link"
         
           aria-hidden="true"
         >
          Manage cookies
        </a>
        
      </li>
      
      <li class="devsite-footer-utility-item
                 devsite-footer-utility-button">
        
        <span class="devsite-footer-utility-description">Get news and tips by email</span>
        
        
        <a class="devsite-footer-utility-link gc-analytics-event"
           href="/updates"
           data-category="Site-Wide Custom Events"
           data-label="Footer Subscribe link"
         >
          Subscribe
        </a>
        
      </li>
      
    </ul>
    
    
<devsite-language-selector>
  <ul role="presentation">
    
    
    <li role="presentation">
      <a role="menuitem" lang="en"
        >English</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="de"
        >Deutsch</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="es_419"
        >Español – América Latina</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="fr"
        >Français</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="id"
        >Indonesia</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="pl"
        >Polski</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="pt_br"
        >Português – Brasil</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="vi"
        >Tiếng Việt</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="zh_cn"
        >中文 – 简体</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="ja"
        >日本語</a>
    </li>
    
    <li role="presentation">
      <a role="menuitem" lang="ko"
        >한국어</a>
    </li>
    
  </ul>
</devsite-language-selector>

  </nav>
</div>
          
        </devsite-footer-utility>
        <devsite-panel>
          
        </devsite-panel>
        
      </section></section>
    <devsite-sitemask></devsite-sitemask>
    <devsite-snackbar></devsite-snackbar>
    <devsite-tooltip ></devsite-tooltip>
    <devsite-heading-link></devsite-heading-link>
    <devsite-analytics>
      
        <script type="application/json" analytics>[]</script>
<script type="application/json" tag-management>{&#34;at&#34;: &#34;True&#34;, &#34;ga4&#34;: [{&#34;id&#34;: &#34;G-QFRN08RN6E&#34;, &#34;purpose&#34;: 0}], &#34;ga4p&#34;: [{&#34;id&#34;: &#34;G-QFRN08RN6E&#34;, &#34;purpose&#34;: 0}], &#34;gtm&#34;: [], &#34;parameters&#34;: {&#34;internalUser&#34;: &#34;False&#34;, &#34;language&#34;: {&#34;machineTranslated&#34;: &#34;False&#34;, &#34;requested&#34;: &#34;en&#34;, &#34;served&#34;: &#34;en&#34;}, &#34;pageType&#34;: &#34;codelab&#34;, &#34;projectName&#34;: null, &#34;signedIn&#34;: &#34;False&#34;, &#34;tenant&#34;: &#34;android&#34;, &#34;recommendations&#34;: {&#34;sourcePage&#34;: &#34;&#34;, &#34;sourceType&#34;: 0, &#34;sourceRank&#34;: 0, &#34;sourceIdenticalDescriptions&#34;: 0, &#34;sourceTitleWords&#34;: 0, &#34;sourceDescriptionWords&#34;: 0, &#34;experiment&#34;: &#34;&#34;}, &#34;experiment&#34;: {&#34;ids&#34;: &#34;&#34;}}}</script>
      
    </devsite-analytics>
    
      <devsite-badger></devsite-badger>
    
    
    
<android-fully-clickable
    target="
        .android-case-study .devsite-landing-row-item,
        .android-editorial-and-updates-cards .devsite-card-content-wrapper,
        .android-editorial-and-updates-cards .devsite-landing-row-item,
        .android-grouped-resources .devsite-landing-row-item,
        .android-grouped-resources-contained--primary .devsite-landing-row-item,
        .android-grouped-resources-contained--secondary .devsite-landing-row-item,
        .android-grouped-resources-contained--tertiary .devsite-landing-row-item,
        .android-grouped-resources-uncontained--primary .devsite-landing-row-item,
        .android-grouped-resources-uncontained--secondary .devsite-landing-row-item,
        .android-grouped-resources-uncontained--tertiary .devsite-landing-row-item,
        .android-guide-cards .devsite-landing-row-item,
        .android-illustrated-resources-index .devsite-landing-row-item,
        .android-illustrated-resources-primary .devsite-landing-row-item,
        .android-illustrated-resources-secondary .devsite-landing-row-item,
        .android-illustrated-resources-secondary-small .devsite-landing-row-item,
        .android-illustrated-resources-tertiary .devsite-landing-row-item,
        .android-illustrated-resources-tertiary-small .devsite-landing-row-item,
        .android-promo .devsite-landing-row-item,
        .android-quick-link,
        .android-samples .devsite-card-wrapper,
        .fully-clickable"
    watch=".android-editorial-and-updates-cards, .android-samples, devsite-content"></android-fully-clickable>
    
<script nonce="v+NczcF5URBqvdrWVfBxqGf+gEQ6O7">
  
  (function(d,e,v,s,i,t,E){d['GoogleDevelopersObject']=i;
    t=e.createElement(v);t.async=1;t.src=s;E=e.getElementsByTagName(v)[0];
    E.parentNode.insertBefore(t,E);})(window, document, 'script',
    'https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/js/app_loader.js', '[3,"en",null,"/js/devsite_app_module.js","https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9","https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android","https://android-dot-devsite-v2-prod.appspot.com",1,null,["/_pwa/android/manifest.json","https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/images/video-placeholder.svg","https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/images/favicon.svg","https://www.gstatic.com/devrel-devsite/prod/vc12d84b6edb3e25e1619b575cf813e1849a1c95098b711a6c56ab3968c9a4fa9/android/images/lockup.png","https://fonts.googleapis.com/css?family=Google+Sans:400,500,600,700|Google+Sans+Text:400,400italic,500,500italic,600,600italic,700,700italic|Roboto+Mono:400,500,700&display=swap"],1,null,[1,6,8,12,14,17,21,25,50,52,63,70,75,76,80,87,91,92,93,97,98,100,101,102,103,104,105,107,108,109,110,112,113,117,118,120,122,124,125,126,127,129,130,131,132,133,134,135,136,138,140,141,147,148,149,151,152,156,157,158,159,161,163,164,168,169,170,179,180,182,183,186,191,193,196],"AIzaSyAP-jjEJBzmIyKR4F-3XITp8yM9T1gEEI8","AIzaSyB6xiKGDR5O3Ak2okS4rLkauxGUG7XP0hg","developer.android.com","AIzaSyAQk0fBONSGUqCNznf6Krs82Ap1-NV6J4o","AIzaSyCCxcqdrZ_7QMeLCRY20bh_SXdAYqy70KY",null,null,null,["DevPro__enable_vertex_credit_card","Experiments__reqs_query_experiments","DevPro__enable_nvidia_credits_card","Profiles__enable_public_developer_profiles","Search__enable_ai_eligibility_checks","Profiles__enable_join_program_group_endpoint","Search__enable_ai_search_summaries_for_all","Profiles__enable_recognition_badges","Concierge__enable_pushui","MiscFeatureFlags__enable_explicit_template_dependencies","Profiles__enable_stripe_subscription_management","DevPro__enable_google_one_card","Profiles__enable_playlist_community_acl","DevPro__enable_google_payments_buyflow","Profiles__enable_completecodelab_endpoint","Concierge__enable_actions_menu","Significatio__enable_by_tenant","MiscFeatureFlags__enable_variable_operator","Profiles__enable_completequiz_endpoint","TpcFeatures__proxy_prod_host","DevPro__remove_eu_tax_intake_form","EngEduTelemetry__enable_engedu_telemetry","DevPro__enable_developer_subscriptions","BookNav__enable_tenant_cache_key","DevPro__enable_embed_profile_creation","Cloud__fast_free_trial","Profiles__enable_purchase_prompts","Profiles__enable_complete_playlist_endpoint","Search__enable_dynamic_content_confidential_banner","MiscFeatureFlags__enable_project_variables","Profiles__enable_callout_notifications","DevPro__enable_cloud_innovators_plus","Cloud__enable_cloud_shell_fte_user_flow","MiscFeatureFlags__emergency_css","Profiles__enable_awarding_url","DevPro__enable_enterprise","MiscFeatureFlags__enable_dark_theme","Profiles__enable_dashboard_curated_recommendations","CloudShell__cloud_shell_button","Profiles__enable_release_notes_notifications","Profiles__enable_user_type","DevPro__enable_code_assist","Cloud__enable_cloud_dlp_service","MiscFeatureFlags__developers_footer_image","Analytics__enable_clearcut_logging","Profiles__enable_profile_collections","TpcFeatures__enable_unmirrored_page_left_nav","MiscFeatureFlags__enable_variable_operator_index_yaml","Search__enable_suggestions_from_borg","DevPro__enable_devpro_offers","DevPro__enable_firebase_workspaces_card","Cloud__enable_cloudx_experiment_ids","Profiles__enable_developer_profile_benefits_ui_redesign","MiscFeatureFlags__gdp_dashboard_reskin_enabled","Cloud__enable_legacy_calculator_redirect","MiscFeatureFlags__enable_appearance_cookies","MiscFeatureFlags__enable_view_transitions","MiscFeatureFlags__developers_footer_dark_image","Profiles__enable_page_saving","Search__enable_page_map","Cloud__cache_serialized_dynamic_content","MiscFeatureFlags__enable_firebase_utm","Cloud__enable_free_trial_server_call","Concierge__enable_remove_info_panel_tags","MiscFeatureFlags__enable_project_body_class","Profiles__require_profile_eligibility_for_signin","CloudShell__cloud_code_overflow_menu","Cloud__enable_cloud_shell","MiscFeatureFlags__enable_framebox_badge_methods","Cloud__enable_llm_concierge_chat","DevPro__enable_free_benefits","Profiles__enable_developer_profiles_callout"],null,null,"AIzaSyBLEMok-5suZ67qRPzx0qUtbnLmyT_kCVE","https://developerscontentserving-pa.googleapis.com","AIzaSyCM4QpTRSqP5qI4Dvjt4OAScIN8sOUlO-k","https://developerscontentsearch-pa.googleapis.com",2,4,null,"https://developerprofiles-pa.googleapis.com",[3,"android","Android Developers","developer.android.com",null,"android-dot-devsite-v2-prod.appspot.com",null,null,[null,1,null,null,null,null,null,null,null,null,null,[1],null,null,null,null,null,null,[1],[1,null,null,[1,20],"/recommendations"],null,null,null,[1,null,1],[1,1,null,1,1]],null,[18,null,null,null,null,null,"/images/lockup.png","/images/touchicon-180.png",null,null,null,null,null,null,null,null,null,null,null,null,null,2,null,null,null,"/images/lockup-dark-theme.png",[]],[],null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,[6,1,14,15,20,22,23,28,29,37,43],null,[[null,null,1],[1,1]],[[null,null,null,null,null,null,null,[["G-QFRN08RN6E"],null,null,[["G-QFRN08RN6E",1]]],null,null,null,null,1],null,[[2,2],[1,1]]],null,4,null,null,null,null,null,null,null,null,null,null,null,null,null,"android.devsite.google"],null,"pk_live_5170syrHvgGVmSx9sBrnWtA5luvk9BwnVcvIi7HizpwauFG96WedXsuXh790rtij9AmGllqPtMLfhe2RSwD6Pn38V00uBCydV4m",1,null,"https://developerscontentinsights-pa.googleapis.com","AIzaSyCg-ZUslalsEbXMfIo9ZP8qufZgo3LSBDU","AIzaSyDxT0vkxnY_KeINtA4LSePJO-4MAZPMRsE","https://developers.googleapis.com",null,null,"AIzaSyBQom12tzI-rybN7Sf-KfeL4nwm-Rf7PmI\n",null,"https://developerslogging.googleapis.com"]')
  
</script>

    <devsite-a11y-announce></devsite-a11y-announce>
  </body>
</html>